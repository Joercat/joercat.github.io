<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Training Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .nav-tab {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .chat-interface {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .user-message {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .bot-message {
            background: #e9ecef;
            color: #333;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
        }

        .patterns-list {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .pattern-item {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .pattern-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .pattern-category {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .pattern-input {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .pattern-response {
            color: #666;
            font-style: italic;
        }

        .pattern-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #999;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .api-url-input {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e1e5e9;
            transition: background-color 0.3s ease;
        }

        .file-item:hover {
            background: #e9ecef;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .analytics-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .three-column {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Chatbot Training Interface</h1>
            <p>Train your AI chatbot with custom responses and monitor performance</p>
        </div>

        <div class="api-url-input">
            <label for="apiUrl">üîó Chatbot API URL:</label>
            <input type="text" id="apiUrl" placeholder="e.g., https://your-chatbot-api.onrender.com">
            <button class="btn" onclick="testConnection()" style="margin-top: 10px;">Test Connection</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('training', event)">üìö Training</button>
            <button class="nav-tab" onclick="showTab('files', event)">üìÅ Files</button>
            <button class="nav-tab" onclick="showTab('analytics', event)">üìä Analytics</button>
            <button class="nav-tab" onclick="showTab('chat', event)">üí¨ Chat</button>
        </div>

        <div class="stats-grid" id="statsGrid">
        </div>

        <div id="training" class="tab-content active">
            <div class="main-content">
                <div class="card">
                    <h2>üìö Add Training Pattern</h2>
                    <form id="trainingForm">
                        <div class="form-group">
                            <label for="category">Category:</label>
                            <select id="category" required>
                                <option value="">Select category</option>
                                <option value="greeting">Greeting</option>
                                <option value="emotion">Emotion</option>
                                <option value="topic">Topic</option>
                                <option value="question">Question</option>
                                <option value="thanks">Thanks</option>
                                <option value="goodbye">Goodbye</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>

                        <div class="form-group" style="display: none;">
                            <label for="customCategory">Custom Category (if selected):</label>
                            <input type="text" id="customCategory" placeholder="Enter custom category">
                        </div>

                        <div class="form-group">
                            <label for="inputPattern">Input Pattern (use | for OR):</label>
                            <input type="text" id="inputPattern" placeholder="hello|hi|hey there" required>
                            <small style="color: #666;">Example: "hello|hi|hey" will match any of these words</small>
                        </div>

                        <div class="form-group">
                            <label for="response">Response:</label>
                            <textarea id="response" placeholder="How the bot should respond..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="confidence">Confidence (0.1 - 1.0):</label>
                            <input type="number" id="confidence" min="0.1" max="1.0" step="0.1" value="1.0">
                        </div>

                        <button type="submit" class="btn">üöÄ Add Training Pattern</button>
                    </form>
                </div>

                <div class="card">
                    <h2>üîç Training Pattern Management</h2>
                    <div style="margin-bottom: 20px;">
                        <select id="filterCategory" onchange="loadPatterns()">
                            <option value="">All Categories</option>
                            <option value="greeting">Greeting</option>
                            <option value="emotion">Emotion</option>
                            <option value="topic">Topic</option>
                            <option value="question">Question</option>
                            <option value="thanks">Thanks</option>
                            <option value="goodbye">Goodbye</option>
                            <option value="custom">Custom</option>
                        </select>
                        <button onclick="loadPatterns()" class="btn btn-small" style="margin-left: 10px;">Refresh</button>
                    </div>
                    <div id="patternsList" class="patterns-list"></div>
                </div>
            </div>

            <div class="chat-interface">
                <h2>üìä Training Data Management</h2>
                <div class="main-content">
                    <div class="form-group">
                        <button onclick="exportTrainingData()" class="btn btn-success">üì§ Export Training Data</button>
                    </div>
                    <div class="form-group">
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                        <button onclick="document.getElementById('importFile').click()" class="btn btn-warning">üì• Import Training Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="files" class="tab-content">
            <div class="main-content">
                <div class="card">
                    <h2>üìÅ File Upload</h2>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div>
                            <p>üìÑ Drag & drop JSON files here or click to browse</p>
                            <input type="file" id="fileInput" multiple accept=".json" style="display: none;">
                        </div>
                    </div>
                    <button onclick="document.getElementById('fileInput').click()" class="btn" style="margin-top: 15px;">Browse Files</button>
                </div>

                <div class="card">
                    <h2>üìÇ Uploaded Files</h2>
                    <button onclick="loadFiles()" class="btn btn-small" style="margin-bottom: 15px;">Refresh</button>
                    <div id="filesList" class="file-list">
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>üìä Compression Statistics</h3>
                    <div id="compressionStats">
                        <div class="loading">Loading compression data...</div>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3>üìà Feedback Analysis</h3>
                    <div id="feedbackAnalysis">
                        <div class="loading">Loading feedback data...</div>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3>üéØ Pattern Performance</h3>
                    <div id="patternPerformance">
                        <div class="loading">Loading pattern performance...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat" class="tab-content">
            <div class="chat-interface">
                <h2>üí¨ Test Chat</h2>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Test your bot here...">
                    <button onclick="sendMessage()" class="btn" style="width: auto; padding: 12px 20px;">Send</button>
                </div>
                <button onclick="clearChat()" class="btn btn-secondary">Clear Chat</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        let apiUrl = 'http://localhost:3000';
        let sessionId = 'training-session-' + Date.now();
        let currentTab = 'training';

        document.addEventListener('DOMContentLoaded', function() {
            const savedApiUrl = localStorage.getItem('chatbotApiUrl');
            if (savedApiUrl) {
                document.getElementById('apiUrl').value = savedApiUrl;
                apiUrl = savedApiUrl;
            } else {
                document.getElementById('apiUrl').value = apiUrl;
            }

            loadStats();
            loadPatterns();
            setupFileUpload();

            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            document.getElementById('importFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    importTrainingData(e.target.files[0]);
                    e.target.value = '';
                }
            });
        });

        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                 event.target.classList.add('active');
            } else {
                document.querySelector(`.nav-tab[onclick*="${tabName}"]`).classList.add('active');
            }

            currentTab = tabName;

            if (tabName === 'files') {
                loadFiles();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        document.getElementById('apiUrl').addEventListener('change', function() {
            apiUrl = this.value.trim();
            localStorage.setItem('chatbotApiUrl', apiUrl);
        });

        async function testConnection() {
            if (!apiUrl) {
                showStatus('‚ùå Please enter an API URL.', 'error');
                return;
            }
            showLoading(true);
            try {
                const response = await fetch(`${apiUrl}/health`);
                const data = await response.json();

                if (response.ok && data.status === 'ok') {
                    showStatus('‚úÖ Connection successful! API is running.', 'success');
                    loadStats();
                } else {
                    showStatus('‚ùå Connection failed. Check your API URL: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Connection failed (Network error or CORS issue): ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function loadStats() {
            try {
                if (!apiUrl) return;

                const response = await fetch(`${apiUrl}/stats`);
                const data = await response.json();

                const statsGrid = document.getElementById('statsGrid');
                if (response.ok) {
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${data.training_patterns || 0}</div>
                            <div class="stat-label">Training Patterns</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.conversation_messages || 0}</div>
                            <div class="stat-label">Conversations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.registered_users || 0}</div>
                            <div class="stat-label">Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.learned_patterns || 0}</div>
                            <div class="stat-label">Learned Patterns</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.uploaded_files || 0}</div>
                            <div class="stat-label">Uploaded Files</div>
                        </div>
                    `;
                } else {
                    statsGrid.innerHTML = `<p style="text-align: center; color: #dc3545;">Could not load stats: ${data.error || 'Server error'}</p>`;
                }
            } catch (error) {
                document.getElementById('statsGrid').innerHTML = `<p style="text-align: center; color: #dc3545;">Failed to connect to API for stats.</p>`;
            }
        }

        document.getElementById('trainingForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!apiUrl) {
                showStatus('‚ùå Please set the Chatbot API URL first.', 'error');
                return;
            }

            const category = document.getElementById('category').value;
            const customCategory = document.getElementById('customCategory').value.trim();
            const inputPattern = document.getElementById('inputPattern').value.trim();
            const responseText = document.getElementById('response').value.trim();
            const confidence = parseFloat(document.getElementById('confidence').value);

            const finalCategory = category === 'custom' ? customCategory : category;

            if (!finalCategory) {
                showStatus('‚ùå Please select or enter a category.', 'error');
                return;
            }
            if (!inputPattern || !responseText) {
                showStatus('‚ùå Input pattern and response are required.', 'error');
                return;
            }

            showLoading(true);

            try {
                const apiResponse = await fetch(`${apiUrl}/train`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category: finalCategory,
                        input_pattern: inputPattern,
                        response: responseText,
                        confidence: confidence
                    })
                });

                const data = await apiResponse.json();

                if (apiResponse.ok) {
                    showStatus('‚úÖ Training pattern added successfully!', 'success');
                    this.reset();
                    document.getElementById('confidence').value = '1.0';
                    document.getElementById('customCategory').parentElement.style.display = 'none';
                    loadPatterns();
                    loadStats();
                } else {
                    showStatus('‚ùå Error: ' + (data.error || 'Failed to add pattern.'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error: ' + error.message, 'error');
            }

            showLoading(false);
        });

        async function loadPatterns() {
            if (!apiUrl) {
                document.getElementById('patternsList').innerHTML = '<p style="text-align: center; color: #666;">Please set the API URL.</p>';
                return;
            }

            const filterCategory = document.getElementById('filterCategory').value;
            showLoading(true);

            try {
                let url = `${apiUrl}/training`;
                if (filterCategory) {
                    url += `?category=${encodeURIComponent(filterCategory)}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                const patternsList = document.getElementById('patternsList');
                patternsList.innerHTML = '';

                if (response.ok && data.patterns && data.patterns.length > 0) {
                    data.patterns.forEach(pattern => {
                        const patternElement = document.createElement('div');
                        patternElement.className = 'pattern-item';
                        patternElement.innerHTML = `
                            <div class="pattern-category">${escapeHTML(pattern.category)}</div>
                            <div class="pattern-input"><strong>Input:</strong> ${escapeHTML(pattern.input_pattern)}</div>
                            <div class="pattern-response"><strong>Response:</strong> ${escapeHTML(pattern.response)}</div>
                            <div class="pattern-stats">
                                <span>Confidence: ${pattern.confidence.toFixed(1)}</span>
                                <span>Used: ${pattern.usage_count} times</span>
                                <span>Added: ${new Date(pattern.created_at).toLocaleDateString()}</span>
                            </div>
                        `;
                        patternsList.appendChild(patternElement);
                    });
                } else if (response.ok) {
                    patternsList.innerHTML = '<p style="text-align: center; color: #666;">No training patterns found for this filter.</p>';
                } else {
                     patternsList.innerHTML = `<p style="text-align: center; color: #dc3545;">Error loading patterns: ${data.error || 'Server error'}</p>`;
                }
            } catch (error) {
                showStatus('‚ùå Error loading patterns: ' + error.message, 'error');
                document.getElementById('patternsList').innerHTML = '<p style="text-align: center; color: #dc3545;">Failed to connect to API for patterns.</p>';
            }

            showLoading(false);
        }

        function setupFileUpload() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');

            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFileUpload(files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFileUpload(e.target.files);
                e.target.value = '';
            });
        }

        async function handleFileUpload(files) {
            if (!apiUrl) {
                showStatus('‚ùå Please set the Chatbot API URL first.', 'error');
                return;
            }

            if (files.length === 0) return;

            showLoading(true);
            let anyError = false;

            for (let file of files) {
                if (file.type !== 'application/json') {
                    showStatus(`‚ùå "${file.name}" - Only JSON files are allowed.`, 'error');
                    anyError = true;
                    continue;
                }
                if (file.size > 0.5 * 1024 * 1024) {
                    showStatus(`‚ùå "${file.name}" - File size exceeds 0.5MB limit.`, 'error');
                    anyError = true;
                    continue;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${apiUrl}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showStatus(`‚úÖ File "${file.name}" uploaded successfully!`, 'success');
                    } else {
                        showStatus(`‚ùå Error uploading "${file.name}": ${data.error || 'Server error'}`, 'error');
                        anyError = true;
                    }
                } catch (error) {
                    showStatus(`‚ùå Network error uploading "${file.name}": ${error.message}`, 'error');
                    anyError = true;
                }
            }
            showLoading(false);
            if (!anyError) {
                loadFiles();
                loadStats();
            }
        }

        async function loadFiles() {
            if (!apiUrl) {
                document.getElementById('filesList').innerHTML = '<p style="text-align: center; color: #666;">Please set the API URL.</p>';
                return;
            }
            showLoading(true);
            try {
                const response = await fetch(`${apiUrl}/uploads`);
                const data = await response.json();

                const filesList = document.getElementById('filesList');
                filesList.innerHTML = '';

                if (response.ok && data.files && data.files.length > 0) {
                    data.files.forEach(file => {
                        const fileElement = document.createElement('div');
                        fileElement.className = 'file-item';
                        fileElement.innerHTML = `
                            <div class="file-info">
                                <div class="file-name">${escapeHTML(file.filename)}</div>
                                <div class="file-size">${formatFileSize(file.size)} ‚Ä¢ ${new Date(file.uploaded_at).toLocaleDateString()}</div>
                            </div>
                            <div class="file-actions">
                                <button onclick="viewFile('${file.id}')" class="btn btn-small btn-secondary">View</button>
                                <button onclick="deleteFile('${file.id}')" class="btn btn-small btn-danger">Delete</button>
                            </div>
                        `;
                        filesList.appendChild(fileElement);
                    });
                } else if (response.ok) {
                    filesList.innerHTML = '<p style="text-align: center; color: #666;">No files uploaded yet.</p>';
                } else {
                    filesList.innerHTML = `<p style="text-align: center; color: #dc3545;">Error loading files: ${data.error || 'Server error'}</p>`;
                }
            } catch (error) {
                showStatus('‚ùå Error loading files: ' + error.message, 'error');
                document.getElementById('filesList').innerHTML = '<p style="text-align: center; color: #dc3545;">Failed to connect to API for files.</p>';
            }
            showLoading(false);
        }

        async function viewFile(fileId) {
            if (!apiUrl) {
                showStatus('‚ùå Please set the Chatbot API URL first.', 'error');
                return;
            }
            showLoading(true);
            try {
                const response = await fetch(`${apiUrl}/uploads/${fileId}`);
                const data = await response.json();

                if (response.ok) {
                    const popup = window.open('', '_blank');
                    if (popup) {
                        popup.document.write(`
                            <html>
                                <head>
                                    <title>File Content: ${escapeHTML(data.filename)}</title>
                                    <style>
                                        body { font-family: monospace; padding: 20px; }
                                        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto; white-space: pre-wrap; word-break: break-all;}
                                    </style>
                                </head>
                                <body>
                                    <h2>File: ${escapeHTML(data.filename)}</h2>
                                    <pre>${escapeHTML(JSON.stringify(data.content, null, 2))}</pre>
                                </body>
                            </html>
                        `);
                        popup.document.close();
                    } else {
                        alert('Please allow pop-ups for this site to view file content.');
                    }
                } else {
                    showStatus('‚ùå Error viewing file: ' + (data.error || 'Server error'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error viewing file: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function deleteFile(fileId) {
            if (!apiUrl) {
                showStatus('‚ùå Please set the Chatbot API URL first.', 'error');
                return;
            }
            if (!confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${apiUrl}/uploads/${fileId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('‚úÖ File deleted successfully!', 'success');
                    loadFiles();
                    loadStats();
                } else {
                    showStatus('‚ùå Error deleting file: ' + (data.error || 'Server error'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error deleting file: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function exportTrainingData() {
            if (!apiUrl) {
                showStatus('‚ùå Please set the Chatbot API URL first.', 'error');
                return;
            }
            showLoading(true);
            try {
                const response = await fetch(`${apiUrl}/export-training`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `training-data-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showStatus('‚úÖ Training data exported successfully!', 'success');
                } else {
                    const data = await response.json();
                    showStatus('‚ùå Error exporting data: ' + (data.error || 'Server error'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error exporting data: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function importTrainingData(file) {
            if (!apiUrl) {
                showStatus('‚ùå Please set the Chatbot API URL first.', 'error');
                return;
            }

            if (file.type !== 'application/json') {
                showStatus(`‚ùå "${file.name}" - Only JSON files can be imported as training data.`, 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showLoading(true);
            try {
                const response = await fetch(`${apiUrl}/import-training`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok || response.status === 206) {
                    showStatus(`‚úÖ Training data imported successfully! Added ${data.imported_count} patterns. ${data.failed_count ? data.failed_count + ' failed.' : ''}`, 'success');
                    loadPatterns();
                    loadStats();
                } else {
                    showStatus('‚ùå Error importing data: ' + (data.error || 'Server error'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error importing data: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function loadAnalytics() {
            document.getElementById('compressionStats').innerHTML = '<div class="loading">Loading compression data...</div>';
            document.getElementById('feedbackAnalysis').innerHTML = '<div class="loading">Loading feedback data...</div>';
            document.getElementById('patternPerformance').innerHTML = '<div class="loading">Loading pattern performance...</div>';

            await Promise.allSettled([
                loadCompressionStats(),
                loadFeedbackAnalysis(),
                loadPatternPerformance()
            ]);
        }

        async function loadCompressionStats() {
            try {
                const response = await fetch(`${apiUrl}/compression-stats`);
                const data = await response.json();

                const compressionStats = document.getElementById('compressionStats');

                if (response.ok) {
                    const compressionRatio = parseFloat(data.compression_ratio || 0);
                    compressionStats.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Compression Ratio:</span>
                                <span><strong>${compressionRatio}%</strong></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${compressionRatio}%"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Original Size:</span>
                                <span>${formatFileSize(data.original_size || 0)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Compressed Size:</span>
                                <span>${formatFileSize(data.compressed_size || 0)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Space Saved:</span>
                                <span>${formatFileSize(data.space_saved || 0)}</span>
                            </div>
                        </div>
                    `;
                } else {
                    compressionStats.innerHTML = `<p style="color: #dc3545;">Error: ${data.error || 'Server error'}</p>`;
                }
            } catch (error) {
                document.getElementById('compressionStats').innerHTML = '<p style="color: #dc3545;">Failed to load compression stats.</p>';
            }
        }

        async function loadFeedbackAnalysis() {
            try {
                const response = await fetch(`${apiUrl}/feedback`);
                const data = await response.json();

                const feedbackAnalysis = document.getElementById('feedbackAnalysis');

                if (response.ok && data.feedback && data.feedback.length > 0) {
                    const positive = data.feedback.filter(f => f.rating >= 4).length;
                    const negative = data.feedback.filter(f => f.rating <= 2).length;
                    const neutral = data.feedback.length - positive - negative;
                    const total = data.feedback.length;

                    const positivePercent = total > 0 ? Math.round((positive / total) * 100) : 0;
                    const neutralPercent = total > 0 ? Math.round((neutral / total) * 100) : 0;
                    const negativePercent = total > 0 ? Math.round((negative / total) * 100) : 0;


                    feedbackAnalysis.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>üòä Positive:</span>
                                <span><strong>${positive} (${positivePercent}%)</strong></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${positivePercent}%; background: #28a745;"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>üòê Neutral:</span>
                                <span><strong>${neutral} (${neutralPercent}%)</strong></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${neutralPercent}%; background: #ffc107;"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>üòû Negative:</span>
                                <span><strong>${negative} (${negativePercent}%)</strong></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${negativePercent}%; background: #dc3545;"></div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <strong>Total Feedback: ${total}</strong>
                        </div>
                    `;
                } else if (response.ok) {
                    feedbackAnalysis.innerHTML = '<p style="color: #666;">No feedback data available.</p>';
                } else {
                    feedbackAnalysis.innerHTML = `<p style="color: #dc3545;">Error: ${data.error || 'Server error'}</p>`;
                }
            } catch (error) {
                document.getElementById('feedbackAnalysis').innerHTML = '<p style="color: #dc3545;">Failed to load feedback data.</p>';
            }
        }

        async function loadPatternPerformance() {
            try {
                const response = await fetch(`${apiUrl}/training`);
                const data = await response.json();

                const patternPerformance = document.getElementById('patternPerformance');

                if (response.ok && data.patterns && data.patterns.length > 0) {
                    const sortedPatterns = data.patterns.sort((a, b) => b.usage_count - a.usage_count).slice(0, 5);
                    const maxUsage = sortedPatterns.length > 0 ? sortedPatterns[0].usage_count : 0;

                    let html = '<div style="margin-bottom: 15px;"><strong>Top 5 Most Used Patterns:</strong></div>';

                    if (sortedPatterns.length === 0) {
                        html += '<p style="text-align: center; color: #666;">No patterns found or used yet.</p>';
                    } else {
                        sortedPatterns.forEach(pattern => {
                            const percentage = maxUsage > 0 ? (pattern.usage_count / maxUsage) * 100 : 0;
                            html += `
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="font-size: 14px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(pattern.input_pattern)}</span>
                                        <span><strong>${pattern.usage_count}</strong></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    patternPerformance.innerHTML = html;
                } else if (response.ok) {
                    patternPerformance.innerHTML = '<p style="color: #666;">No patterns to analyze yet.</p>';
                } else {
                    patternPerformance.innerHTML = `<p style="color: #dc3545;">Error: ${data.error || 'Server error'}</p>`;
                }
            } catch (error) {
                document.getElementById('patternPerformance').innerHTML = '<p style="color: #dc3545;">Failed to load pattern performance.</p>';
            }
        }

        async function sendMessage() {
            if (!apiUrl) {
                addMessageToChat('bot', 'Error: Please set the Chatbot API URL first.');
                return;
            }
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            addMessageToChat('user', message);
            input.value = '';

            try {
                const response = await fetch(`${apiUrl}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: sessionId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessageToChat('bot', data.response);
                } else {
                    addMessageToChat('bot', 'Error: ' + (data.error || 'Failed to get response.'));
                }
            } catch (error) {
                addMessageToChat('bot', 'Network error: ' + error.message);
            }
        }

        function addMessageToChat(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}-message`;
            messageElement.textContent = message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chatMessages').innerHTML = '';
            sessionId = 'training-session-' + Date.now();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showStatus(message, type) {
            const existingStatus = document.querySelector('.status');
            if (existingStatus) {
                existingStatus.remove();
            }

            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;

            document.querySelector('.container').insertBefore(statusDiv, document.querySelector('.nav-tabs'));

            setTimeout(() => {
                statusDiv.remove();
            }, 5000);
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        document.getElementById('category').addEventListener('change', function() {
            const customCategoryDiv = document.getElementById('customCategory').parentElement;
            customCategoryDiv.style.display = this.value === 'custom' ? 'block' : 'none';
            if (this.value !== 'custom') {
                document.getElementById('customCategory').value = '';
            }
        });

        setInterval(loadStats, 30000);

        setInterval(() => {
            if (!document.getElementById('loading').style.display || document.getElementById('loading').style.display === 'none') {
                if (currentTab === 'files') {
                    loadFiles();
                } else if (currentTab === 'analytics') {
                    loadAnalytics();
                }
            }
        }, 60000);

        showTab('training', null);
    </script>
</body>
</html>
