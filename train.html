<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trainer (Tokenizer & JSON)</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        :root {
            --primary-bg: #1e1e2f; --secondary-bg: #27293d; --text-color: #d9e0ee;
            --accent-color: #89b4fa; --green-color: #a6e3a1; --red-color: #f38ba8;
            --border-color: #45475a; --warn-color: #fab387; --purple-color: #cba6f7;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; background-color: var(--primary-bg); color: var(--text-color); }
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; background-color: var(--primary-bg); overflow: hidden; }
        .header { padding: 10px; background-color: var(--secondary-bg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .header button { padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.2s ease; }
        .start-btn { background-color: var(--green-color); color: var(--primary-bg); }
        .stop-btn { background-color: var(--red-color); color: var(--primary-bg); }
        .export-btn { background-color: var(--accent-color); color: var(--primary-bg); }
        .tab-nav { display: flex; background-color: var(--secondary-bg); }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background: none; color: var(--text-color); opacity: 0.7; border-bottom: 2px solid transparent; }
        .tab-button.active { opacity: 1; border-bottom: 2px solid var(--accent-color); font-weight: bold; }
        .tab-content { display: none; flex-grow: 1; overflow-y: auto; padding: 15px; }
        .tab-content.active { display: flex; flex-direction: column; }
        #message-list { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .message { padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .user-message { background-color: var(--accent-color); color: var(--primary-bg); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background-color: var(--secondary-bg); align-self: flex-start; border-bottom-left-radius: 5px; }
        .message-feedback { display: flex; gap: 8px; margin-top: 8px; }
        .feedback-btn { cursor: pointer; opacity: 0.5; transition: opacity 0.2s; }
        #chat-form { display: flex; padding-top: 15px; border-top: 1px solid var(--border-color); }
        #chat-input { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--secondary-bg); color: var(--text-color); margin-right: 10px; }
        #chat-form button { padding: 10px 15px; border-radius: 5px; border: none; background-color: var(--accent-color); color: var(--primary-bg); cursor: pointer; }
        #console-log { flex-grow: 1; background-color: #11111b; color: #cdd6f4; font-family: 'Courier New', monospace; font-size: 0.9em; padding: 10px; border-radius: 5px; white-space: pre-wrap; word-break: break-all; overflow-y: auto; }
        .log-error { color: var(--red-color); } .log-warn { color: var(--warn-color); } .log-info { color: var(--green-color); } .log-db { color: var(--accent-color); } .log-ai { color: var(--purple-color); }
        #training-data-view-controls { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .data-table-container { flex-grow: 1; overflow: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 8px 12px; border: 1px solid var(--border-color); text-align: left; font-size: 0.9em; }
        .data-table th { background-color: var(--secondary-bg); }
        .tokens-cell { max-width: 200px; word-wrap: break-word; color: var(--purple-color); font-size: 0.8em !important; }
    </style>
</head>
<body></body>
<script>
document.addEventListener('DOMContentLoaded', () => {
    puter.ui.showAppWindow({ name: 'AI Trainer (Tokenizer & JSON)', width: 900, height: 700 }).then(appWindow => {
        appWindow.getBody().innerHTML = `
            <div class="app-container">
                <div class="header">
                    <button id="start-gen-btn" class="start-btn">Start Data Generation</button>
                    <button id="stop-gen-btn" class="stop-btn">Stop Data Generation</button>
                    <div id="status-indicator">Status: Idle</div>
                </div>
                <div class="tab-nav">
                    <button class="tab-button active" data-tab="chat-container">Chat</button>
                    <button class="tab-button" data-tab="training-data-view">View Training Data</button>
                    <button class="tab-button" data-tab="console-container">Console</button>
                </div>
                <div id="chat-container" class="tab-content active">
                    <div id="message-list"><div class="message ai-message">Hello! This version tokenizes data and allows JSON export. Start data generation (requires a logged-in Puter account), then ask a question.</div></div>
                    <form id="chat-form"><input type="text" id="chat-input" placeholder="Type a prompt..." autocomplete="off"><button type="submit">Send</button></form>
                </div>
                <div id="training-data-view" class="tab-content">
                    <div id="training-data-view-controls">
                        <button id="refresh-data-btn">Refresh View</button>
                        <button id="export-json-btn" class="export-btn">Export to JSON</button>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead><tr><th>ID</th><th>Prompt</th><th>Response</th><th>Prompt Tokens</th><th>Response Tokens</th><th>Rating</th></tr></thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="console-container" class="tab-content"><div id="console-log"></div></div>
            </div>`;

        // --- GLOBAL STATE & UI ELEMENTS ---
        let generationInterval = null;
        const ui = {
            startBtn: appWindow.getBody().querySelector('#start-gen-btn'),
            stopBtn: appWindow.getBody().querySelector('#stop-gen-btn'),
            statusIndicator: appWindow.getBody().querySelector('#status-indicator'),
            messageList: appWindow.getBody().querySelector('#message-list'),
            chatForm: appWindow.getBody().querySelector('#chat-form'),
            chatInput: appWindow.getBody().querySelector('#chat-input'),
            consoleLog: appWindow.getBody().querySelector('#console-log'),
            dataTableBody: appWindow.getBody().querySelector('#data-table-body'),
            refreshBtn: appWindow.getBody().querySelector('#refresh-data-btn'),
            exportBtn: appWindow.getBody().querySelector('#export-json-btn'),
        };

        // --- UTILITIES (Logger, Tokenizer, DB) ---
        const Logger = {
            log: (message, type = '') => {
                const entry = document.createElement('div');
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                if(type) entry.classList.add(`log-${type}`);
                ui.consoleLog.appendChild(entry);
                ui.consoleLog.scrollTop = ui.consoleLog.scrollHeight;
            },
            info: (msg) => Logger.log(msg, 'info'), warn: (msg) => Logger.log(msg, 'warn'),
            error: (msg) => Logger.log(msg, 'error'), db: (msg) => Logger.log(msg, 'db'),
            ai: (msg) => Logger.log(msg, 'ai'),
        };

        class SimpleTokenizer {
            constructor() { this.vocab = new Map(); this.inverseVocab = new Map(); this.nextId = 0; }
            tokenize(text) { return text.toLowerCase().match(/\w+|\s+|[^\s\w]+/g) || []; }
            fitOnText(text) {
                for (const token of this.tokenize(text)) {
                    if (!this.vocab.has(token)) {
                        this.vocab.set(token, this.nextId); this.inverseVocab.set(this.nextId, token); this.nextId++;
                    }
                }
            }
            encode(text) { this.fitOnText(text); return this.tokenize(text).map(token => this.vocab.get(token)); }
            decode(tokenIds) { return tokenIds.map(id => this.inverseVocab.get(id) || '').join(''); }
        }
        const tokenizer = new SimpleTokenizer();

        const DB = {
            db: null,
            init: () => new Promise((resolve, reject) => {
                const request = indexedDB.open('aiTrainingDB_Tokenizer', 1);
                request.onerror = e => { Logger.error(`DB Error: ${e.target.errorCode}`); reject(); };
                request.onsuccess = e => { DB.db = e.target.result; Logger.db('Database initialized.'); resolve(); };
                request.onupgradeneeded = e => {
                    e.target.result.createObjectStore('training_data', { keyPath: 'id', autoIncrement: true })
                                  .createIndex('prompt', 'prompt', { unique: false });
                };
            }),
            addEntry: (prompt, response) => new Promise((resolve, reject) => {
                const newEntry = {
                    prompt,
                    response,
                    prompt_tokens: tokenizer.encode(prompt),
                    response_tokens: tokenizer.encode(response),
                    rating: 'none',
                    timestamp: new Date()
                };
                const tx = DB.db.transaction(['training_data'], 'readwrite');
                const req = tx.objectStore('training_data').add(newEntry);
                req.onsuccess = () => { Logger.info(`Tokenized and added data for prompt: "${prompt.substring(0, 30)}..."`); resolve(); };
                req.onerror = e => { Logger.error(`Failed to add data: ${e.target.error}`); reject(); };
            }),
            findResponse: (prompt) => new Promise(resolve => {
                const req = DB.db.transaction(['training_data'], 'readonly').objectStore('training_data').index('prompt').getAll(prompt);
                req.onsuccess = () => {
                    if (!req.result || req.result.length === 0) return resolve(null);
                    const liked = req.result.find(r => r.rating === 'like');
                    resolve(liked || req.result.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0]);
                };
                req.onerror = () => resolve(null);
            }),
            updateRating: (id, rating) => new Promise((resolve, reject) => { /* ... unchanged ... */ }),
            getAll: () => new Promise(resolve => {
                const req = DB.db.transaction(['training_data'], 'readonly').objectStore('training_data').getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            }),
        };
        // Stub for brevity, full implementation below in event listeners
        DB.updateRating = (id, rating) => new Promise((resolve, reject) => {
            const store = DB.db.transaction(['training_data'], 'readwrite').objectStore('training_data');
            const req = store.get(id);
            req.onsuccess = () => {
                const data = req.result;
                if (!data) return reject('ID not found');
                data.rating = rating;
                store.put(data).onsuccess = () => { Logger.info(`Updated rating for ID ${id} to "${rating}"`); resolve(); };
            };
            req.onerror = e => reject(e.target.error);
        });

        // --- LIVE GPT-4 DATA GENERATOR ---
        const DataGenerator = {
            prompts: [ /* ... unchanged ... */ ],
            generatePair: async () => { /* ... unchanged ... */ }
        };
        DataGenerator.prompts = [
            "Generate a short, creative story about a robot who discovers music.", "Explain the concept of zero-knowledge proofs in simple terms.",
            "Write a python function that finds the nth Fibonacci number and explain the code.", "What were the primary motivations behind the Apollo space program?",
            "Describe three potential real-world applications of quantum computing in the next decade.", "Create a recipe for a vegan lasagna.",
            "Summarize the philosophical concept of Stoicism.", `The current date is ${new Date().toLocaleDateString()}. What are some interesting historical events that happened on this day?`
        ];
        DataGenerator.generatePair = async () => {
            const randomPrompt = DataGenerator.prompts[Math.floor(Math.random() * DataGenerator.prompts.length)];
            Logger.ai(`Sending prompt to GPT-4: "${randomPrompt.substring(0, 50)}..."`);
            try {
                const result = await puter.ai.run({ model: 'gpt-4', prompt: `You are an AI generating training data. Keep your response to 1-2 paragraphs. Respond to the following prompt: ${randomPrompt}` });
                await DB.addEntry(randomPrompt, result.output);
            } catch (error) {
                Logger.error(`AI call failed. Are you logged into Puter.com with active credits? Details: ${error.message}`);
                ui.stopBtn.click();
            }
        };

        // --- UI & EVENT LISTENERS ---
        const setupEventListeners = () => {
            ui.startBtn.addEventListener('click', () => {
                if (generationInterval) { Logger.warn('Generation already running.'); return; }
                Logger.info('Starting LIVE data generation...');
                ui.statusIndicator.textContent = 'Status: Running';
                DataGenerator.generatePair();
                generationInterval = setInterval(DataGenerator.generatePair, 20000); // 20s to be safe on costs
            });

            ui.stopBtn.addEventListener('click', () => {
                if (!generationInterval) { Logger.warn('Generation not running.'); return; }
                Logger.info('Stopping data generation.');
                ui.statusIndicator.textContent = 'Status: Idle';
                clearInterval(generationInterval);
                generationInterval = null;
            });
            
            appWindow.getBody().querySelector('.tab-nav').addEventListener('click', e => {
                if (e.target.matches('.tab-button')) {
                    appWindow.getBody().querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    appWindow.getBody().querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    appWindow.getBody().querySelector(`#${e.target.dataset.tab}`).classList.add('active');
                    if (e.target.dataset.tab === 'training-data-view') renderTrainingData();
                }
            });

            const renderTrainingData = async () => {
                const data = await DB.getAll();
                ui.dataTableBody.innerHTML = '';
                data.sort((a,b) => b.id - a.id).forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.prompt}</td>
                        <td>${item.response}</td>
                        <td class="tokens-cell">${item.prompt_tokens.join(', ')}</td>
                        <td class="tokens-cell">${item.response_tokens.join(', ')}</td>
                        <td>${item.rating}</td>`;
                    ui.dataTableBody.appendChild(row);
                });
            };

            ui.refreshBtn.addEventListener('click', renderTrainingData);

            ui.exportBtn.addEventListener('click', async () => {
                Logger.info('Exporting data to JSON...');
                const data = await DB.getAll();
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'training_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                Logger.info('JSON file download initiated.');
            });

            ui.chatForm.addEventListener('submit', async (e) => { /* ... unchanged ... */ });
            const addMessage = (text, sender, dbId) => { /* ... unchanged ... */ };
            ui.messageList.addEventListener('click', e => { /* ... unchanged ... */ });

            // Full implementation of listeners from previous version
            ui.chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = ui.chatInput.value.trim();
                if (!userInput) return;
                addMessage(userInput, 'user');
                ui.chatInput.value = '';
                const storedResponse = await DB.findResponse(userInput);
                addMessage(storedResponse ? storedResponse.response : "I haven't been trained on that specific prompt yet.", 'ai', storedResponse ? storedResponse.id : null);
            });
            const addMessage = (text, sender, dbId) => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${sender}-message`;
                messageEl.innerHTML = `<div>${text.replace(/\n/g, '<br>')}</div>`;
                if (sender === 'ai' && dbId) {
                    messageEl.innerHTML += `<div class="message-feedback"><span class="feedback-btn" data-id="${dbId}" data-rating="like">👍</span> <span class="feedback-btn" data-id="${dbId}" data-rating="dislike">👎</span></div>`;
                }
                ui.messageList.appendChild(messageEl);
                ui.messageList.scrollTop = ui.messageList.scrollHeight;
            };
            ui.messageList.addEventListener('click', e => {
                if (e.target.matches('.feedback-btn')) {
                    DB.updateRating(parseInt(e.target.dataset.id), e.target.dataset.rating)
                      .catch(err => Logger.error(err));
                }
            });
        };

        // --- INITIALIZE APP ---
        DB.init().then(setupEventListeners).catch(err => Logger.error("App failed to initialize."));
    });
});
</script>
</html>
