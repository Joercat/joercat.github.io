<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimal-ui">
    <title>SCos 2.0 Mobile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.4/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        @media (hover: none) and (pointer: coarse) {
            :root {
                --main-color: #39FF14;
                --bg-dark: black;
                --bg-image: url('green.jpg') no-repeat center center / cover;
                --window-bg: #1a1a1a;
                --text-color: var(--main-color);
            }
        
            html {
                touch-action: pan-x pan-y;
            }
        
            body {
                background-color: black;
                background: var(--bg-image);
                color: var(--text-color);
                overflow: hidden;
                height: 100vh;
                margin: 0;
                padding: 0;
                overscroll-behavior: none;
                display: flex;
                flex-direction: column;
                font-family: 'Roboto', sans-serif;
            }
        
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
        
            #loading-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--bg-dark);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                transition: opacity 0.5s;
            }
        
            .logo-text {
                font-size: 48px;
                letter-spacing: 2px;
                margin-bottom: 20px;
            }
        
            .spinning-o {
                display: inline-block;
                animation: spin 1s linear infinite;
                color: #39FF14;
                font-weight: bold;
                text-shadow: 0 0 10px #39FF14, 0 0 20px #39FF14;
            }
        
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
        
                100% {
                    transform: rotate(360deg);
                }
            }
        
            .loading-bar {
                width: 80%;
                max-width: 300px;
                height: 20px;
                border: 2px solid var(--main-color);
                margin: 20px 0;
            }
        
            .loading-progress {
                width: 0;
                height: 100%;
                background: var(--main-color);
                transition: width 0.1s;
            }
        
            .boot-messages {
                background-color: black;
                margin-top: 20px;
                text-align: left;
                font-size: 14px;
                max-width: 80%;
            }
        
            #desktop {
                flex-grow: 1;
                padding: 10px;
                overflow-y: auto;
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-start;
                align-content: flex-start;
                gap: 10px;
                transition: filter 0.3s ease;
                padding-bottom: 50px;
            }
        
            #desktop.blurred {
                filter: blur(5px);
            }
        
            .desktop-icons {
                display: contents;
            }
        
            .icon {
                width: 70px;
                text-align: center;
                cursor: pointer;
                padding: 10px 5px;
                border-radius: 5px;
                transition: all 0.2s;
                font-size: 12px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        
            .icon:active {
                background: rgba(57, 255, 20, 0.3);
            }
        
            .icon i {
                font-size: 2em;
            }
        
            .icon span {
                display: block;
                margin-top: 5px;
                font-size: 11px;
            }
        
            .window {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: var(--window-bg);
                border: 1px solid var(--main-color);
                box-shadow: 0 0 15px rgba(57, 255, 20, 0.2);
                transition: transform 0.3s, opacity 0.3s;
                transform: translateX(100%);
                opacity: 0;
                z-index: 1000;
                display: flex;
                flex-direction: column;
            }
        
            .window.active {
                transform: translateX(0);
                opacity: 1;
            }
        
            .window-header {
                background: var(--main-color);
                color: var(--bg-dark);
                padding: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                touch-action: none;
                cursor: grab;
                display: none;
            }
        
            .window-controls {
                display: flex;
                gap: 5px;
            }
        
            .window-control {
                padding: 2px 8px;
                cursor: pointer;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 3px;
            }
        
            .window-content {
                flex-grow: 1;
                overflow: auto;
                padding: 10px;
                display: flex;
                flex-direction: column;
                padding-bottom: 50px;
            }
        
            .terminal-content {
                height: 100%;
                background: #000;
                padding: 10px;
                font-family: 'Courier New', monospace;
                overflow-y: auto;
                color: var(--main-color);
                white-space: pre-wrap;
            }
        
            .terminal-line {
                margin: 2px 0;
                white-space: pre-wrap;
            }
        
            .terminal-prompt {
                color: var(--main-color);
                margin-right: 5px;
            }
        
            .terminal-input-container {
                display: flex;
                align-items: flex-start;
                word-break: break-all;
            }
        
            #terminal-typed-command {
                flex-grow: 1;
                white-space: pre-wrap;
            }
        
            .terminal-input {
                background: transparent;
                border: none;
                color: transparent;
                font-family: 'Courier New', monospace;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: 0;
                outline: none;
            }
        
            .blink-cursor {
                border-right: 1px solid var(--main-color);
                animation: blink 1s step-end infinite;
            }
        
            @keyframes blink {
                from, to {
                    border-right-color: transparent
                }
        
                50% {
                    border-right-color: var(--main-color);
                }
            }
        
            .browser-content {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
        
            .browser-toolbar {
                display: flex;
                padding: 5px;
                gap: 5px;
                background: rgba(57, 255, 20, 0.1);
            }
        
            .browser-toolbar input {
                flex-grow: 1;
                background: #333;
                border: 1px solid var(--main-color);
                color: var(--main-color);
                padding: 5px;
                outline: none;
                font-size: 12px;
            }
        
            .browser-toolbar button {
                background: #333;
                color: var(--main-color);
                border: 1px solid var(--main-color);
                padding: 5px 10px;
                cursor: pointer;
            }
        
            .browser-content iframe {
                width: 100%;
                height: 100%;
                border: none;
                margin: 0;
                background: white;
            }
        
            .calendar-app {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
        
            .calendar-toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                background: rgba(57, 255, 20, 0.1);
                font-size: 14px;
            }
        
            .calendar-toolbar button {
                padding: 5px;
            }
        
            .calendar-grid {
                flex: 1;
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                background: rgba(57, 255, 20, 0.1);
                padding: 5px;
                font-size: 12px;
            }
        
            .calendar-day {
                aspect-ratio: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                background: var(--window-bg);
            }
        
            .calendar-day:active {
                background: rgba(57, 255, 20, 0.3);
            }
        
            .calendar-day.today {
                background: var(--main-color);
                color: var(--bg-dark);
            }
        
            .calendar-header {
                background: rgba(57, 255, 20, 0.2);
                font-weight: bold;
                text-align: center;
                padding: 5px 0;
            }
        
            .taskbar {
                height: 40px;
                background: rgba(26, 26, 26, 0.95);
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0 10px;
                border-top: 1px solid var(--main-color);
            }
        
            .running-apps {
                display: flex;
                gap: 5px;
                overflow-x: auto;
                flex-grow: 1;
                scrollbar-width: none;
            }
        
            .running-apps::-webkit-scrollbar {
                display: none;
            }
        
            .task-item {
                padding: 5px 10px;
                cursor: pointer;
                border-radius: 3px;
                background: rgba(57, 255, 20, 0.1);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100px;
                font-size: 12px;
            }
        
            .task-item:active {
                background: rgba(57, 255, 20, 0.2);
            }
        
            .files-content {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
        
            .files-toolbar {
                padding: 5px;
                background: rgba(57, 255, 20, 0.1);
                display: flex;
                gap: 5px;
                align-items: center;
            }
        
            .files-toolbar button {
                padding: 5px 8px;
            }
        
            .files-path {
                background: #333;
                color: var(--main-color);
                border: 1px solid var(--main-color);
                padding: 5px;
                flex-grow: 1;
                font-size: 12px;
            }
        
            .files-list {
                flex: 1;
                padding: 10px;
                overflow-y: auto;
            }
        
            .file-item {
                padding: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                border-radius: 3px;
                font-size: 14px;
            }
        
            .file-item:active {
                background: rgba(57, 255, 20, 0.1);
            }
        
            .notepad-content {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
        
            .notepad-toolbar {
                padding: 5px;
                background: rgba(57, 255, 20, 0.1);
                display: flex;
                gap: 5px;
            }
        
            .notepad-editor {
                flex: 1;
                background: var(--window-bg);
                color: var(--main-color);
                border: none;
                padding: 10px;
                resize: none;
                font-family: 'Courier New', monospace;
                outline: none;
                font-size: 14px;
            }
        
            .settings-content {
                padding: 10px;
            }
        
            .setting-group {
                margin-bottom: 15px;
            }
        
            .setting-group h4 {
                margin-bottom: 5px;
            }
        
            select,
            button {
                background: #333;
                color: var(--main-color);
                border: 1px solid var(--main-color);
                padding: 5px 10px;
                cursor: pointer;
                outline: none;
                font-size: 12px;
            }
        
            select:active,
            button:active {
                background: var(--main-color);
                color: var(--bg-dark);
            }
        
            .themes-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
                margin-top: 5px;
            }
        
            .theme-preview {
                height: 50px;
                cursor: pointer;
                border: 1px solid var(--main-color);
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
                padding: 5px;
                font-size: 12px;
            }
        
            .about-content {
                text-align: center;
                padding: 10px;
                font-size: 14px;
            }
        
            .about-logo {
                font-size: 28px;
                margin-bottom: 10px;
                color: #39FF14;
            }
        
            .about-info {
                margin-bottom: 10px;
            }
        
            .about-content ul {
                text-align: left;
                margin: 5px 0 5px 20px;
                padding: 0;
            }
        
            .ai-content {
                flex-grow: 1;
                padding: 10px;
                display: flex;
                flex-direction: column;
                background-color: #000;
                overflow-y: auto;
            }
        
            .ai-message {
                margin-bottom: 10px;
                padding: 8px;
                border-radius: 5px;
                max-width: 80%;
            }
        
            .ai-message.user {
                background-color: var(--main-color);
                color: var(--bg-dark);
                align-self: flex-end;
            }
        
            .ai-message.assistant {
                background-color: rgba(57, 255, 20, 0.2);
                color: var(--text-color);
                align-self: flex-start;
            }
        
            .ai-input-container {
                display: flex;
                padding: 10px;
                border-top: 1px solid var(--main-color);
            }
        
            .ai-input-container input {
                flex-grow: 1;
                background-color: #333;
                border: 1px solid var(--main-color);
                color: var(--main-color);
                padding: 8px;
                outline: none;
                font-size: 14px;
            }
        
            .ai-input-container button {
                background: var(--main-color);
                color: var(--bg-dark);
                border: 1px solid var(--main-color);
                padding: 8px 12px;
                margin-left: 5px;
                cursor: pointer;
            }
        
            .ai-message-timestamp {
                font-size: 10px;
                color: #888;
                margin-top: 5px;
            }
        
        
            .matrix-1 {
                --main-color: #39FF14;
                --bg-image: url('green.jpg') no-repeat center center / cover;
                --window-bg: #1a1a1a;
                --text-color: var(--main-color);
            }
        
            .blue-sky {
                --main-color: #00AAFF;
                --bg-image: url('blue.jpg') no-repeat center center / cover;
                --window-bg: #002B4D;
                --text-color: var(--main-color);
            }
        
            .midnight-purple {
                --main-color: #CC66FF;
                --bg-image: url('purple.jpg') no-repeat center center / cover;
                --window-bg: #330066;
                --text-color: var(--main-color);
            }
        
            .amber-tech {
                --main-color: #FF0000;
                --bg-image: url('red.jpg') no-repeat center center / cover;
                --window-bg: #4D0000;
                --text-color: var(--main-color);
            }
        
            #bottom-nav {
                display: flex;
                justify-content: space-around;
                align-items: center;
                height: 50px;
                width: 100%;
                background: rgba(0, 0, 0, 0.8);
                border-top: 1px solid var(--main-color);
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 9999;
            }
        
            .nav-button {
                width: 33.33%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                color: var(--main-color);
                font-size: 1.5em;
                cursor: pointer;
                transition: background-color 0.2s;
            }
        
            .nav-button:active {
                background-color: rgba(57, 255, 20, 0.2);
            }
        
            #recents-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.9);
                z-index: 999;
                display: none;
                flex-direction: column;
                padding: 10px;
                overflow-y: auto;
            }
        
            .recent-app-card {
                background: var(--window-bg);
                border: 1px solid var(--main-color);
                margin-bottom: 10px;
                padding: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
            }
        
            .appstore-app {
                display: flex;
                align-items: center;
                padding: 10px;
                border-bottom: 1px solid var(--main-color);
            }
        
            .appstore-app-icon {
                font-size: 2.5em;
                margin-right: 15px;
            }
        
            .appstore-app-details {
                flex-grow: 1;
            }
        
            .appstore-app-details h4 {
                margin-bottom: 5px;
            }
        
            .appstore-app-details p {
                font-size: 12px;
                color: #888;
            }
        
            .appstore-app button {
                padding: 5px 10px;
            }
        
            .calculator-content {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
        
            .calculator-display {
                background-color: black;
                color: var(--main-color);
                text-align: right;
                padding: 10px;
                font-size: 2em;
                overflow-x: auto;
                white-space: nowrap;
                border-bottom: 1px solid var(--main-color);
            }
        
            .calculator-buttons {
                flex-grow: 1;
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 5px;
                padding: 10px;
            }
        
            .calc-button {
                padding: 20px;
                font-size: 1.5em;
                background: #333;
                border: 1px solid var(--main-color);
                color: var(--main-color);
                cursor: pointer;
            }
        
            .calc-button:active {
                background: var(--main-color);
                color: var(--bg-dark);
            }
        
            .calc-button.operator {
                background: rgba(57, 255, 20, 0.3);
            }
        
            .calc-button.equals {
                grid-column: span 2;
            }
        
            .image-viewer-content,
            .media-player-content {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                gap: 10px;
            }
        
            .file-input-container {
                display: flex;
                gap: 10px;
                align-items: center;
            }
        
            .file-input-container label {
                padding: 10px;
                background: var(--main-color);
                color: var(--bg-dark);
                cursor: pointer;
            }
        
            .file-input-container input {
                display: none;
            }
        
            .image-viewer-content img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }
        
            .media-player-content video {
                max-width: 100%;
                max-height: 100%;
            }
        
            .notes-content {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
        
            #notes-list {
                list-style: none;
                flex-grow: 1;
                overflow-y: auto;
            }
        
            .note-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                border-bottom: 1px solid var(--main-color);
            }
        
            .notes-editor {
                flex: 1;
                background: var(--window-bg);
                color: var(--main-color);
                border: none;
                padding: 10px;
                resize: none;
                font-family: 'Courier New', monospace;
                outline: none;
                font-size: 14px;
            }
        
            .timer-stopwatch-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
            }
        
            #timer-stopwatch-display {
                font-size: 3em;
                margin-bottom: 20px;
            }
        
            .timer-stopwatch-controls {
                display: flex;
                gap: 10px;
            }
        
            #weather-app-container {
                text-align: center;
            }
        
            #weather-city-input {
                padding: 8px;
                font-size: 16px;
                margin-bottom: 10px;
                width: 80%;
            }
        
            #weather-data {
                margin-top: 20px;
            }
        
            .weather-icon {
                font-size: 5em;
                margin-bottom: 10px;
            }
        
            #weather-city {
                font-size: 2em;
            }
        
            #weather-temp {
                font-size: 3em;
            }
        
            #weather-description {
                font-size: 1.5em;
                margin-top: 10px;
            }
        
            .tic-tac-toe-content {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: 5px;
                width: 300px;
                height: 300px;
                margin: auto;
            }
        
            .tic-tac-toe-cell {
                width: 100%;
                height: 100%;
                background: var(--window-bg);
                border: 1px solid var(--main-color);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2em;
                cursor: pointer;
            }

            .install-progress-bar {
                width: 100%;
                height: 10px;
                background-color: #333;
                border: 1px solid var(--main-color);
                margin-top: 10px;
            }

            .install-progress {
                height: 100%;
                width: 0;
                background-color: var(--main-color);
                transition: width 0.3s ease;
            }
        }
        
        @media (hover: hover) and (pointer: fine) {
            body {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div id="loading-screen">
        <div class="logo-text">SC<span class="spinning-o">o</span>s</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
        <div class="boot-messages"></div>
    </div>

    <div id="desktop">
        <div class="desktop-icons">
            <div class="icon" data-app="files">
                <i class="fas fa-folder fa-2x"></i>
                <span>Files</span>
            </div>
            <div class="icon" data-app="terminal">
                <i class="fas fa-terminal fa-2x"></i>
                <span>Terminal</span>
            </div>
            <div class="icon" data-app="notepad">
                <i class="fas fa-edit fa-2x"></i>
                <span>Notepad</span>
            </div>
            <div class="icon" data-app="browser">
                <i class="fas fa-globe fa-2x"></i>
                <span>Browser</span>
            </div>
            <div class="icon" data-app="calendar">
                <i class="fas fa-calendar fa-2x"></i>
                <span>Calendar</span>
            </div>
            <div class="icon" data-app="settings">
                <i class="fas fa-cog fa-2x"></i>
                <span>Settings</span>
            </div>
            <div class="icon" data-app="ai">
                <i class="fas fa-brain fa-2x"></i>
                <span>AI</span>
            </div>
            <div class="icon" data-app="about">
                <i class="fas fa-info-circle fa-2x"></i>
                <span>About</span>
            </div>
            <div class="icon" data-app="appstore">
                <i class="fas fa-store fa-2x"></i>
                <span>App Store</span>
            </div>
        </div>
    </div>

    <div id="bottom-nav">
        <div class="nav-button" id="back-button">
            <i class="fas fa-arrow-left"></i>
        </div>
        <div class="nav-button" id="home-button">
            <i class="fas fa-circle"></i>
        </div>
        <div class="nav-button" id="recents-button">
            <i class="fas fa-square"></i>
        </div>
    </div>

    <div id="recents-panel"></div>

    <script>
        const System = {
            currentTheme: 'matrix-1',
            bootComplete: false,
            terminalAliases: {},
            aiAPIKey: "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",
            openWeatherMapAPIKey: "YOUR_OPENWEATHERMAP_API_KEY", // This is not needed anymore
            runningApps: [],
            activeWindow: null,
            installedApps: [
                { name: 'files', title: 'Files', icon: 'fas fa-folder' },
                { name: 'terminal', title: 'Terminal', icon: 'fas fa-terminal' },
                { name: 'notepad', title: 'Notepad', icon: 'fas fa-edit' },
                { name: 'browser', title: 'Browser', icon: 'fas fa-globe' },
                { name: 'calendar', title: 'Calendar', icon: 'fas fa-calendar' },
                { name: 'settings', title: 'Settings', icon: 'fas fa-cog' },
                { name: 'ai', title: 'AI', icon: 'fas fa-brain' },
                { name: 'about', title: 'About', icon: 'fas fa-info-circle' },
                { name: 'appstore', title: 'App Store', icon: 'fas fa-store' }
            ],

            async init() {
                this.FileSystem.init();
                this.loadInstalledApps();
                this.applyTheme(this.loadTheme());
                await this.startBootSequence();
                this.WindowManager.init();
                this.initDesktop();
                this.initNavigation();
            },

            async startBootSequence() {
                const loadingBar = document.querySelector('.loading-progress');
                const bootMessages = document.querySelector('.boot-messages');
                const loadingScreen = document.getElementById('loading-screen');

                const bootSteps = [
                    { message: 'Initializing system core...', duration: 1000 },
                    { message: 'Loading file system...', duration: 800 },
                    { message: 'Starting window manager...', duration: 600 },
                    { message: 'Loading desktop environment...', duration: 700 },
                    { message: 'Finishing... Welcome to SCos!', duration: 600 }
                ];

                let totalProgress = 0;

                for (const step of bootSteps) {
                    const msgElement = document.createElement('div');
                    msgElement.textContent = step.message;
                    bootMessages.appendChild(msgElement);

                    await new Promise(resolve => setTimeout(resolve, step.duration));

                    totalProgress += 20;
                    loadingBar.style.width = `${totalProgress}%`;
                }

                this.bootComplete = true;
                await new Promise(resolve => setTimeout(resolve, 500));
                loadingScreen.style.opacity = '0';
                await new Promise(resolve => setTimeout(resolve, 500));
                loadingScreen.style.display = 'none';
            },

            loadTheme() {
                try {
                    const settings = JSON.parse(this.FileSystem.read('system/settings.json') || '{}');
                    return settings.theme || 'matrix-1';
                } catch (e) {
                    return 'matrix-1';
                }
            },

            FileSystem: {
                data: {},
                currentPath: '/',

                init() {
                    this.data = JSON.parse(localStorage.getItem('filesystem')) || {
                        'home/': {
                            'documents/': {
                                'welcome.txt': 'Welcome to SCos!\nThis is your personal computer system.',
                                'changelog.txt': 'SCos 2.0 Mobile Changelog:\n- New App Store apps\n- Full File support for images and media\n- New scientific calculator'
                            },
                            'downloads/': {},
                            'desktop/': {}
                        },
                        'system/': {
                            'settings.json': JSON.stringify({
                                theme: 'matrix-1',
                                version: '2.0 Mobile'
                            }),
                            'about.txt': 'SCos - Simulated Computer Operating System\nVersion 2.0 Mobile\nDeveloped with ♥ by the SCos team',
                            'network.json': JSON.stringify({
                                'google.com': { ip: '172.217.160.142', status: 'online', latency: '45ms' },
                                'example.com': { ip: '93.184.216.34', status: 'online', latency: '60ms' },
                                'local.net': { ip: '192.168.1.1', status: 'online', latency: '5ms' },
                                'offline.site': { ip: '10.0.0.1', status: 'offline', latency: 'timeout' }
                            })
                        }
                    };
                    this.save();
                },

                save() {
                    localStorage.setItem('filesystem', JSON.stringify(this.data));
                },

                read(path) {
                    return this.traverse(path);
                },

                write(path, content) {
                    const parts = path.split('/').filter(p => p);
                    let current = this.data;

                    for (let i = 0; i < parts.length - 1; i++) {
                        const part = parts[i] + '/';
                        if (!current[part]) current[part] = {};
                        current = current[part];
                    }

                    const fileName = parts[parts.length - 1];
                    current[fileName] = content;
                    this.save();
                    return true;
                },

                list(path = '/') {
                    const content = this.traverse(path);
                    return typeof content === 'object' ? Object.keys(content) : [];
                },

                isDirectory(path) {
                    const item = this.traverse(path);
                    return item && typeof item === 'object';
                },

                mkdir(path) {
                    if (path.endsWith('/')) {
                        const parts = path.split('/').filter(p => p);
                        let current = this.data;

                        for (let i = 0; i < parts.length; i++) {
                            const part = parts[i] + '/';
                            if (!current[part]) current[part] = {};
                            current = current[part];
                        }
                        this.save();
                        return true;
                    }
                    return false;
                },

                delete(path) {
                    const parts = path.split('/').filter(p => p);
                    let current = this.data;

                    if (parts.length === 0) return false;

                    if (parts.length === 1) {
                        const key = parts[0].endsWith('/') ? parts[0] : parts[0];
                        if (current[key] !== undefined) {
                            delete current[key];
                            this.save();
                            return true;
                        }
                        return false;
                    }

                    for (let i = 0; i < parts.length - 1; i++) {
                        const part = parts[i] + (parts[i].endsWith('/') ? '' : '/');
                        if (!current[part]) return false;
                        current = current[part];
                    }

                    const lastPart = parts[parts.length - 1];
                    const key = lastPart.endsWith('/') ? lastPart : lastPart;

                    if (current[key] !== undefined) {
                        delete current[key];
                        this.save();
                        return true;
                    }

                    return false;
                },

                traverse(path) {
                    if (!path || path === '/') return this.data;
                    const parts = path.split('/').filter(p => p);
                    let current = this.data;

                    for (const part of parts) {
                        const withSlash = part + '/';
                        current = current[withSlash] || current[part];
                        if (!current) return null;
                    }
                    return current;
                }
            },

            WindowManager: {
                windows: [],
                windowIdCounter: 0,

                init() {
                    const desktop = document.getElementById('desktop');
                    desktop.addEventListener('touchstart', (e) => {
                        const appIcon = e.target.closest('.icon');
                        if (appIcon) {
                            e.preventDefault();
                            System.openApp(appIcon.dataset.app);
                        }
                    });
                },

                create(title, content, appId = null, options = {}) {
                    const windowId = `window-${++this.windowIdCounter}`;
                    const existingWindow = System.runningApps.find(app => app.appId === appId);
                    if (existingWindow) {
                        this.showWindow(existingWindow.id);
                        return document.getElementById(existingWindow.id);
                    }

                    const window = document.createElement('div');
                    window.className = 'window';
                    window.id = windowId;
                    window.dataset.appId = appId;

                    const windowContent = document.createElement('div');
                    windowContent.className = 'window-content';
                    windowContent.innerHTML = content;

                    window.appendChild(windowContent);
                    document.body.appendChild(window);

                    setTimeout(() => {
                        window.classList.add('active');
                        System.activeWindow = window;
                        document.getElementById('desktop').classList.add('blurred');
                        System.runningApps.push({ id: windowId, title: title, appId: appId });
                        System.updateRecentsPanel();
                    }, 10);

                    if (options.onload) {
                        options.onload(window);
                    }

                    return window;
                },

                closeActiveWindow() {
                    if (System.activeWindow) {
                        const windowToClose = System.activeWindow;
                        const windowId = windowToClose.id;

                        windowToClose.classList.remove('active');
                        document.getElementById('desktop').classList.remove('blurred');

                        setTimeout(() => {
                            windowToClose.remove();
                            System.runningApps = System.runningApps.filter(app => app.id !== windowId);
                            System.activeWindow = null;
                            System.updateRecentsPanel();
                        }, 300);
                    }
                },

                closeWindow(windowId) {
                    const windowToClose = document.getElementById(windowId);
                    if (windowToClose) {
                        windowToClose.classList.remove('active');

                        if (System.activeWindow && System.activeWindow.id === windowId) {
                            document.getElementById('desktop').classList.remove('blurred');
                            System.activeWindow = null;
                        }

                        setTimeout(() => {
                            windowToClose.remove();
                            System.runningApps = System.runningApps.filter(app => app.id !== windowId);
                            System.updateRecentsPanel();
                        }, 300);
                    }
                },

                showWindow(windowId) {
                    const window = document.getElementById(windowId);
                    if (window) {
                        if (System.activeWindow) {
                            System.activeWindow.classList.remove('active');
                        }
                        System.activeWindow = window;
                        window.classList.add('active');
                        document.getElementById('desktop').classList.add('blurred');
                    }
                }
            },

            initDesktop() {
                const desktopIcons = document.querySelector('.desktop-icons');
                desktopIcons.innerHTML = '';
                this.installedApps.forEach(app => {
                    const icon = document.createElement('div');
                    icon.className = 'icon';
                    icon.dataset.app = app.name;
                    icon.innerHTML = `
                        <i class="${app.icon} fa-2x"></i>
                        <span>${app.title}</span>
                    `;
                    desktopIcons.appendChild(icon);
                });
            },

            initNavigation() {
                document.getElementById('home-button').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (this.activeWindow) {
                        this.WindowManager.closeActiveWindow();
                    }
                    document.getElementById('recents-panel').style.display = 'none';
                });

                document.getElementById('back-button').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (document.getElementById('recents-panel').style.display === 'flex') {
                        document.getElementById('recents-panel').style.display = 'none';
                    } else if (this.activeWindow) {
                        this.WindowManager.closeActiveWindow();
                    }
                });

                document.getElementById('recents-button').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.toggleRecentsPanel();
                });
            },

            updateRecentsPanel() {
                const recentsPanel = document.getElementById('recents-panel');
                recentsPanel.innerHTML = '';
                this.runningApps.forEach(app => {
                    const appCard = document.createElement('div');
                    appCard.className = 'recent-app-card';
                    appCard.textContent = app.title;
                    appCard.dataset.windowId = app.id;

                    appCard.addEventListener('touchstart', (e) => {
                        e.stopPropagation();
                        this.WindowManager.showWindow(app.id);
                        recentsPanel.style.display = 'none';
                    });

                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = '×';
                    closeBtn.style.background = 'transparent';
                    closeBtn.style.border = 'none';
                    closeBtn.style.color = 'red';
                    closeBtn.style.fontSize = '1.5em';
                    closeBtn.style.cursor = 'pointer';

                    closeBtn.addEventListener('touchstart', (e) => {
                        e.stopPropagation();
                        this.WindowManager.closeWindow(app.id);
                    });

                    appCard.appendChild(closeBtn);
                    recentsPanel.appendChild(appCard);
                });
            },

            toggleRecentsPanel() {
                const recentsPanel = document.getElementById('recents-panel');
                if (recentsPanel.style.display === 'flex') {
                    recentsPanel.style.display = 'none';
                } else {
                    recentsPanel.style.display = 'flex';
                }
            },

            loadInstalledApps() {
                const storedApps = JSON.parse(localStorage.getItem('installedApps'));
                if (storedApps) {
                    this.installedApps = storedApps;
                } else {
                    localStorage.setItem('installedApps', JSON.stringify(this.installedApps));
                }
            },

            async installApp(app, installButton) {
                if (!this.installedApps.some(a => a.name === app.name)) {
                    const appSize = app.size || 1000; // Default size for simulation
                    const installTime = appSize / 100; // Simulate install time
                    let progress = 0;

                    const progressBarContainer = document.createElement('div');
                    progressBarContainer.className = 'install-progress-bar';
                    const progressBar = document.createElement('div');
                    progressBar.className = 'install-progress';
                    progressBarContainer.appendChild(progressBar);
                    installButton.replaceWith(progressBarContainer);

                    const interval = setInterval(() => {
                        progress += 1;
                        if (progress > 100) {
                            clearInterval(interval);
                            progressBarContainer.remove();
                            this.installedApps.push(app);
                            localStorage.setItem('installedApps', JSON.stringify(this.installedApps));
                            this.initDesktop();
                            const newButton = document.createElement('button');
                            newButton.textContent = 'Installed';
                            newButton.disabled = true;
                            newButton.classList.add('installed-button');
                            installButton.parentElement.appendChild(newButton);
                        } else {
                            progressBar.style.width = `${progress}%`;
                        }
                    }, installTime / 100);
                }
            },

            openApp(appName) {
                const apps = {
                    files: () => this.createFilesWindow(),
                    terminal: () => this.createTerminalWindow(),
                    notepad: () => this.createNotepadWindow(),
                    browser: () => this.createBrowserWindow(),
                    calendar: () => this.createCalendarWindow(),
                    settings: () => this.createSettingsWindow(),
                    ai: () => this.createAIWindow(),
                    about: () => this.createAboutWindow(),
                    appstore: () => this.createAppStoreWindow(),
                    calculator: () => this.createCalculatorWindow(),
                    imageviewer: () => this.createImageViewerWindow(),
                    notes: () => this.createNotesAppWindow(),
                    timerstopwatch: () => this.createTimerStopwatchWindow(),
                    weather: () => this.createWeatherAppWindow(),
                    tictactoe: () => this.createTicTacToeWindow()
                };

                if (apps[appName]) {
                    apps[appName]();
                }
            },

            createFilesWindow() {
                let currentPath = '/';

                const content = `
                    <div class="files-content">
                        <div class="files-toolbar">
                            <button id="files-back"><i class="fas fa-arrow-left"></i></button>
                            <button id="files-up"><i class="fas fa-arrow-up"></i></button>
                            <button id="files-refresh"><i class="fas fa-sync"></i></button>
                            <input type="text" class="files-path" value="/" readonly>
                            <button id="files-new-folder"><i class="fas fa-folder-plus"></i></button>
                        </div>
                        <div class="files-list"></div>
                    </div>
                `;

                const window = this.WindowManager.create('File Explorer', content, 'files', {
                    onload: (window) => {
                        const filesPath = window.querySelector('.files-path');
                        const filesList = window.querySelector('.files-list');
                        const backBtn = window.querySelector('#files-back');
                        const upBtn = window.querySelector('#files-up');
                        const refreshBtn = window.querySelector('#files-refresh');
                        const newFolderBtn = window.querySelector('#files-new-folder');

                        const loadDirectory = (path) => {
                            currentPath = path;
                            filesPath.value = path;
                            filesList.innerHTML = '';

                            const files = this.FileSystem.list(path);
                            files.forEach(file => {
                                const isDir = file.endsWith('/');
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item';
                                fileItem.innerHTML = `
                                    <i class="fas ${isDir ? 'fa-folder' : 'fa-file'}" style="color: var(--main-color)"></i>
                                    <span>${file}</span>
                                `;

                                fileItem.addEventListener('touchstart', (e) => {
                                    e.preventDefault();
                                    if (isDir) {
                                        loadDirectory(currentPath + file);
                                    } else {
                                        const filePath = currentPath + file;
                                        const content = this.FileSystem.read(filePath);

                                        if (file.endsWith('.txt')) {
                                            this.createNotepadWindow(file, content, filePath);
                                        } else if (file.endsWith('.json')) {
                                            this.createNotepadWindow(file, JSON.stringify(content, null, 2), filePath);
                                        } else {
                                            this.createNotepadWindow(file, String(content), filePath);
                                        }
                                    }
                                });

                                filesList.appendChild(fileItem);
                            });
                        };

                        backBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            const parts = currentPath.split('/').filter(p => p);
                            if (parts.length > 0) {
                                parts.pop();
                                loadDirectory('/' + parts.join('/') + (parts.length > 0 ? '/' : ''));
                            }
                        });

                        upBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            const parts = currentPath.split('/').filter(p => p);
                            if (parts.length > 0) {
                                parts.pop();
                                loadDirectory('/' + parts.join('/') + (parts.length > 0 ? '/' : ''));
                            }
                        });

                        refreshBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            loadDirectory(currentPath);
                        });

                        newFolderBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            const folderName = prompt('Enter folder name:');
                            if (folderName && !folderName.includes('/')) {
                                this.FileSystem.mkdir(currentPath + folderName + '/');
                                loadDirectory(currentPath);
                            }
                        });

                        loadDirectory(currentPath);
                    }
                });

                return window;
            },

            createTerminalWindow() {
                const content = `
                    <div class="terminal-content" id="terminal-content">
                        <div class="terminal-line">SCos Terminal v2.0 Mobile</div>
                        <div class="terminal-line">Type 'help' for available commands. Unrecognized commands will be processed by the AI.</div>
                        <div class="terminal-input-container">
                            <span class="terminal-prompt">user@scos:~$</span>
                            <span id="terminal-typed-command"></span><span id="terminal-cursor" class="blink-cursor">|</span><input type="text" class="terminal-input" id="terminal-input">
                        </div>
                    </div>
                `;

                const window = this.WindowManager.create('Terminal', content, 'terminal', {
                    onload: (window) => {
                        const terminalContent = window.querySelector('#terminal-content');
                        const terminalInput = window.querySelector('#terminal-input');
                        const terminalTypedCommand = window.querySelector('#terminal-typed-command');
                        const terminalCursor = window.querySelector('#terminal-cursor');
                        let commandHistory = [];
                        let historyIndex = -1;
                        let currentDirectory = '/home/';
                        let currentTypingIndex = 0;
                        let currentTypingText = '';
                        let typingInterval = null;

                        const startTypingEffect = (text, targetElement, callback) => {
                            currentTypingText = text;
                            currentTypingIndex = 0;
                            targetElement.textContent = '';
                            terminalCursor.style.display = 'inline';

                            if (typingInterval) clearInterval(typingInterval);

                            typingInterval = setInterval(() => {
                                if (currentTypingIndex < currentTypingText.length) {
                                    targetElement.textContent += currentTypingText.charAt(currentTypingIndex);
                                    currentTypingIndex++;
                                    terminalContent.scrollTop = terminalContent.scrollHeight;
                                } else {
                                    clearInterval(typingInterval);
                                    typingInterval = null;
                                    terminalCursor.style.display = 'inline';
                                    if (callback) callback();
                                }
                            }, 10);
                        };

                        terminalContent.addEventListener('touchstart', () => {
                            terminalInput.focus();
                        });

                        terminalInput.focus();

                        const addLine = (text, isPrompt = false) => {
                            const newLine = document.createElement('div');
                            newLine.className = 'terminal-line';
                            if (isPrompt) {
                                newLine.innerHTML = `<span class="terminal-prompt">user@scos:${currentDirectory}$</span>`;
                                const span = document.createElement('span');
                                newLine.appendChild(span);
                                terminalContent.insertBefore(newLine, terminalInput.parentElement);
                                startTypingEffect(text, span, () => {
                                    terminalCursor.style.display = 'inline';
                                    terminalInput.focus();
                                });
                            } else {
                                terminalCursor.style.display = 'none';
                                terminalContent.insertBefore(newLine, terminalInput.parentElement);
                                startTypingEffect(text, newLine, () => {
                                    terminalCursor.style.display = 'inline';
                                    terminalInput.focus();
                                });
                            }
                        };

                        const executeCommand = async (command) => {
                            if (typingInterval) {
                                return;
                            }

                            if (command.trim()) {
                                commandHistory.push(command);
                                historyIndex = commandHistory.length;
                            }

                            const cmdLine = document.createElement('div');
                            cmdLine.className = 'terminal-line';
                            cmdLine.innerHTML = `<span class="terminal-prompt">user@scos:${currentDirectory}$</span> ${command}`;
                            terminalContent.insertBefore(cmdLine, terminalInput.parentElement);

                            let response = '';
                            let showTypingEffect = true;

                            let effectiveCommand = command;
                            const aliasMatch = command.match(/^(\w+)\s*=\s*['"]?(.+)['"]?$/);
                            if (aliasMatch) {
                                const aliasName = aliasMatch[1];
                                const aliasCmd = aliasMatch[2];
                                System.terminalAliases[aliasName] = aliasCmd;
                                response = `Alias '${aliasName}' set to '${aliasCmd}'`;
                                showTypingEffect = true;
                            } else {
                                const parts = command.trim().split(' ');
                                const potentialAlias = parts[0];
                                if (System.terminalAliases[potentialAlias]) {
                                    effectiveCommand = System.terminalAliases[potentialAlias] + ' ' + parts.slice(1).join(' ');
                                }
                            }

                            const args = effectiveCommand.trim().split(' ');
                            const cmd = args[0].toLowerCase();

                            switch (cmd) {
                                case 'help':
                                    response = `Available commands:
help     - Show this help message
ls       - List directory contents
cd       - Change directory
cat      - Show file contents
echo     - Display a message
clear    - Clear terminal screen
date     - Show current date and time
mkdir    - Create directory
touch    - Create an empty file
rm       - Delete file or directory
whoami   - Show current user
version  - Show system version
calc     - Perform basic arithmetic
ping     - Ping a host
sysinfo  - Display system information
alias    - Create command aliases
history  - Show command history
shutdown - Shut down the system
reboot   - Reboot the system`;
                                    break;

                                case 'ls':
                                    try {
                                        const path = args[1] || currentDirectory;
                                        const files = System.FileSystem.list(path);
                                        response = files.length ? files.join('  ') : '(empty directory)';
                                    } catch (err) {
                                        response = 'Error: Invalid path or permission denied.';
                                    }
                                    break;

                                case 'cd':
                                    try {
                                        const path = args[1] || '/home/';

                                        let targetPath;
                                        if (path.startsWith('/')) {
                                            targetPath = path;
                                        } else if (path === '..') {
                                            const parts = currentDirectory.split('/').filter(p => p);
                                            parts.pop();
                                            targetPath = '/' + parts.join('/') + (parts.length > 0 ? '/' : '');
                                        } else {
                                            targetPath = currentDirectory + path + (path.endsWith('/') ? '' : '/');
                                        }

                                        if (!targetPath.endsWith('/')) targetPath += '/';

                                        if (System.FileSystem.isDirectory(targetPath)) {
                                            currentDirectory = targetPath;
                                            response = `Changed directory to ${targetPath}`;
                                        } else {
                                            response = `Error: Directory not found: ${targetPath}`;
                                        }
                                    } catch (err) {
                                        response = 'Error: Invalid path.';
                                    }
                                    break;

                                case 'cat':
                                    try {
                                        const filename = args[1];
                                        if (!filename) {
                                            response = 'Error: No filename specified';
                                        } else {
                                            const path = filename.startsWith('/') ? filename : currentDirectory + filename;
                                            const content = System.FileSystem.read(path);
                                            response = content !== null ? String(content) : 'Error: File not found';
                                        }
                                    } catch (err) {
                                        response = 'Error: Failed to read file.';
                                    }
                                    break;

                                case 'echo':
                                    response = args.slice(1).join(' ');
                                    break;

                                case 'clear':
                                    while (terminalContent.firstChild !== terminalInput.parentElement) {
                                        terminalContent.removeChild(terminalContent.firstChild);
                                    }
                                    response = '';
                                    showTypingEffect = false;
                                    break;

                                case 'date':
                                    response = new Date().toString();
                                    break;

                                case 'mkdir':
                                    try {
                                        const dirname = args[1];
                                        if (!dirname) {
                                            response = 'Error: No directory name specified';
                                        } else {
                                            const path = dirname.startsWith('/') ? dirname : currentDirectory + dirname;
                                            const success = System.FileSystem.mkdir(path + '/');
                                            response = success ? `Directory created: ${path}/` : 'Error: Failed to create directory';
                                        }
                                    } catch (err) {
                                        response = 'Error: Failed to create directory.';
                                    }
                                    break;

                                case 'touch':
                                    try {
                                        const filename = args[1];
                                        if (!filename) {
                                            response = 'Error: No filename specified';
                                        } else {
                                            const path = filename.startsWith('/') ? filename : currentDirectory + filename;
                                            const success = System.FileSystem.write(path, '');
                                            response = success ? `File created: ${path}` : 'Error: Failed to create file';
                                        }
                                    } catch (err) {
                                        response = 'Error: Failed to create file.';
                                    }
                                    break;

                                case 'rm':
                                    try {
                                        const targetPath = args[1];
                                        if (!targetPath) {
                                            response = 'Error: No file or directory specified.';
                                        } else {
                                            const path = targetPath.startsWith('/') ? targetPath : currentDirectory + targetPath;
                                            const success = System.FileSystem.delete(path);
                                            response = success ? `Removed: ${path}` : 'Error: File or directory not found.';
                                        }
                                    } catch (err) {
                                        response = 'Error: Failed to remove file/directory.';
                                    }
                                    break;

                                case 'whoami':
                                    response = 'user';
                                    break;

                                case 'version':
                                    response = 'SCos version 2.0 Mobile, Terminal v2.0 Mobile';
                                    break;

                                case 'calc':
                                    try {
                                        const expression = args.slice(1).join(' ');
                                        const result = math.evaluate(expression);
                                        response = `Result: ${result}`;
                                    } catch (err) {
                                        response = `Error: Invalid expression.`;
                                    }
                                    break;

                                case 'ping':
                                    const host = args[1];
                                    if (!host) {
                                        response = 'Usage: ping <hostname>';
                                    } else {
                                        showTypingEffect = false;
                                        const networkData = JSON.parse(System.FileSystem.read('system/network.json') || '{}');
                                        const hostInfo = networkData[host];
                                        if (hostInfo) {
                                            let pingOutput = `PING ${hostInfo.ip} (${host}): 56 data bytes\n`;
                                            if (hostInfo.status === 'online') {
                                                const packets = 4;
                                                for (let i = 0; i < packets; i++) {
                                                    pingOutput += `64 bytes from ${hostInfo.ip}: icmp_seq=${i + 1} ttl=64 time=${hostInfo.latency}\n`;
                                                    await new Promise(r => setTimeout(r, Math.random() * 200 + 100));
                                                }
                                                pingOutput += `\n--- ${host} ping statistics ---\n`;
                                                pingOutput += `${packets} packets transmitted, ${packets} received, 0% packet loss\n`;
                                                pingOutput += `round-trip min/avg/max/stddev = 0.0/${parseFloat(hostInfo.latency)}/${parseFloat(hostInfo.latency)}/0.0 ms\n`;
                                            } else {
                                                pingOutput += `Request timeout for icmp_seq 0\n`;
                                                await new Promise(r => setTimeout(r, 1000));
                                                pingOutput += `Request timeout for icmp_seq 1\n`;
                                                await new Promise(r => setTimeout(r, 1000));
                                                pingOutput += `Request timeout for icmp_seq 2\n`;
                                                pingOutput += `\n--- ${host} ping statistics ---\n`;
                                                pingOutput += `4 packets transmitted, 0 received, 100% packet loss, time 3000ms\n`;
                                            }
                                            response = pingOutput;
                                        } else {
                                            response = `ping: cannot resolve ${host}: Unknown host`;
                                        }
                                    }
                                    break;

                                case 'sysinfo':
                                    const totalMem = 4096;
                                    const freeMem = (Math.random() * 1024 + 1024).toFixed(2);
                                    response = `SCos System Information:
OS Version: ${System.FileSystem.read('system/settings.json') ? JSON.parse(System.FileSystem.read('system/settings.json')).version : 'Unknown'}
Kernel: SCos-2.0-beta
Architecture: x86_64 (simulated)
Uptime: ${Math.floor(performance.now() / 1000 / 60)} minutes
Total Memory: ${totalMem} MB
Free Memory: ${freeMem} MB
CPU Cores: 2
Storage Used: ${(() => {
                                            const fsData = localStorage.getItem('filesystem');
                                            const bytes = fsData ? fsData.length : 0;
                                            if (bytes < 1024) return `${bytes} bytes`;
                                            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
                                            return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
                                        })()}
Current Time: ${new Date().toLocaleString()}`;
                                    break;

                                case 'alias':
                                    if (args.length === 1) {
                                        let aliasList = 'Current aliases:\n';
                                        for (const key in System.terminalAliases) {
                                            aliasList += `${key}='${System.terminalAliases[key]}'\n`;
                                        }
                                        response = aliasList === 'Current aliases:\n' ? 'No aliases set.' : aliasList;
                                    } else {
                                        const aliasString = args.slice(1).join(' ');
                                        const match = aliasString.match(/^(\w+)\s*=\s*['"]?(.+)['"]?$/);
                                        if (match) {
                                            const aliasName = match[1];
                                            const aliasCmd = match[2];
                                            System.terminalAliases[aliasName] = aliasCmd;
                                            response = `Alias '${aliasName}' set to '${aliasCmd}'`;
                                        } else {
                                            response = 'Usage: alias <name>=\'<command>\'';
                                        }
                                    }
                                    break;

                                case 'history':
                                    if (commandHistory.length === 0) {
                                        response = 'No commands in history.';
                                    } else {
                                        response = commandHistory.map((cmd, idx) => `${idx + 1}  ${cmd}`).join('\n');
                                    }
                                    break;

                                case 'shutdown':
                                    response = 'Shutting down SCos... Goodbye!';
                                    await new Promise(r => setTimeout(r, 1500));
                                    window.close();
                                    break;


                                case 'reboot':
                                    response = 'Rebooting SCos... Please wait.';
                                    await new Promise(r => setTimeout(r, 1500));
                                    location.reload();
                                    break;

                                case '':
                                    break;

                                default:
                                    response = await System.getAIResponse(command);
                                    if (!response) {
                                        response = `Command not found: ${cmd}. Type 'help' for available commands.`;
                                    }
                            }

                            if (response) {
                                if (showTypingEffect) {
                                    await new Promise(resolve => {
                                        const responseLine = document.createElement('div');
                                        responseLine.className = 'terminal-line';
                                        terminalContent.insertBefore(responseLine, terminalInput.parentElement);
                                        startTypingEffect(response, responseLine, resolve);
                                    });
                                } else {
                                    const responseLine = document.createElement('div');
                                    responseLine.className = 'terminal-line';
                                    responseLine.textContent = response;
                                    terminalContent.insertBefore(responseLine, terminalInput.parentElement);
                                }
                            }

                            terminalInput.value = '';
                            terminalTypedCommand.textContent = '';
                            terminalContent.scrollTop = terminalContent.scrollHeight;
                        };

                        terminalInput.addEventListener('input', () => {
                            terminalTypedCommand.textContent = terminalInput.value;
                        });

                        terminalInput.addEventListener('keydown', async (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                const command = terminalInput.value;
                                terminalInput.value = '';
                                terminalTypedCommand.textContent = '';
                                await executeCommand(command);
                            } else if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                if (historyIndex > 0) {
                                    historyIndex--;
                                    terminalInput.value = commandHistory[historyIndex];
                                    terminalTypedCommand.textContent = terminalInput.value;
                                }
                            } else if (e.key === 'ArrowDown') {
                                e.preventDefault();
                                if (historyIndex < commandHistory.length - 1) {
                                    historyIndex++;
                                    terminalInput.value = commandHistory[historyIndex];
                                    terminalTypedCommand.textContent = terminalInput.value;
                                } else if (historyIndex === commandHistory.length - 1) {
                                    historyIndex = commandHistory.length;
                                    terminalInput.value = '';
                                    terminalTypedCommand.textContent = '';
                                }
                            }
                        });

                        setTimeout(() => {
                            executeCommand('');
                        }, 100);
                    }
                });

                return window;
            },

            createNotepadWindow(filename = 'Untitled.txt', content = '', filepath = null) {
                const windowContent = `
                    <div class="notepad-content">
                        <div class="notepad-toolbar">
                            <button id="notepad-save">Save</button>
                            <button id="notepad-save-as">Save As</button>
                        </div>
                        <textarea class="notepad-editor" id="notepad-editor">${content}</textarea>
                    </div>
                `;

                const window = this.WindowManager.create(`Notepad - ${filename}`, windowContent, 'notepad', {
                    onload: (window) => {
                        const editor = window.querySelector('#notepad-editor');
                        const saveBtn = window.querySelector('#notepad-save');
                        const saveAsBtn = window.querySelector('#notepad-save-as');

                        editor.focus();

                        saveBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            if (filepath) {
                                this.FileSystem.write(filepath, editor.value);
                                alert('File saved successfully!');
                            } else {
                                const newFilepath = prompt('Enter file path to save:', 'home/documents/untitled.txt');
                                if (newFilepath) {
                                    this.FileSystem.write(newFilepath, editor.value);
                                    alert('File saved successfully!');
                                    filepath = newFilepath;
                                    window.querySelector('.window-header span').textContent = `Notepad - ${newFilepath.split('/').pop()}`;
                                }
                            }
                        });

                        saveAsBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            const newFilepath = prompt('Enter file path to save:', filepath || 'home/documents/untitled.txt');
                            if (newFilepath) {
                                this.FileSystem.write(newFilepath, editor.value);
                                alert('File saved successfully!');
                                filepath = newFilepath;
                                window.querySelector('.window-header span').textContent = `Notepad - ${newFilepath.split('/').pop()}`;
                            }
                        });
                    }
                });

                return window;
            },

            createBrowserWindow() {
                const content = `
                    <div class="browser-content">
                        <div class="browser-toolbar">
                            <button id="browser-back"><i class="fas fa-arrow-left"></i></button>
                            <button id="browser-forward"><i class="fas fa-arrow-right"></i></button>
                            <input type="text" id="browser-url" value="https://whatever-you-want-here.global.ssl.fastly.net/">
                            <button id="browser-go"><i class="fas fa-arrow-right"></i></button>
                        </div>
                        <iframe id="browser-iframe" src="https://whatever-you-want-here.global.ssl.fastly.net/"></iframe>
                    </div>
                `;

                const window = this.WindowManager.create('Web Browser', content, 'browser', {
                    onload: (window) => {
                        const iframe = window.querySelector('#browser-iframe');
                        const urlInput = window.querySelector('#browser-url');
                        const goBtn = window.querySelector('#browser-go');
                        const backBtn = window.querySelector('#browser-back');
                        const forwardBtn = window.querySelector('#browser-forward');

                        goBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            let url = urlInput.value;
                            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                                url = 'https://' + url;
                            }
                            iframe.src = url;
                        });

                        backBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            iframe.contentWindow.history.back();
                        });

                        forwardBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            iframe.contentWindow.history.forward();
                        });
                    }
                });

                return window;
            },

            createCalendarWindow() {
                const today = new Date();

                const content = `
                    <div class="calendar-app">
                        <div class="calendar-toolbar">
                            <div>
                                <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
                                <button id="next-month"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <h3 id="month-year"></h3>
                            <button id="today-btn">Today</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                `;

                const window = this.WindowManager.create('Calendar', content, 'calendar', {
                    onload: (window) => {
                        const monthYearElement = window.querySelector('#month-year');
                        const calendarGrid = window.querySelector('#calendar-grid');
                        const prevMonthBtn = window.querySelector('#prev-month');
                        const nextMonthBtn = window.querySelector('#next-month');
                        const todayBtn = window.querySelector('#today-btn');

                        let currentDate = new Date();
                        let currentMonth = currentDate.getMonth();
                        let currentYear = currentDate.getFullYear();

                        const renderCalendar = () => {
                            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                'July', 'August', 'September', 'October', 'November', 'December'
                            ];
                            monthYearElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;

                            calendarGrid.innerHTML = '';

                            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                            dayNames.forEach(day => {
                                const dayHeader = document.createElement('div');
                                dayHeader.className = 'calendar-header';
                                dayHeader.textContent = day;
                                calendarGrid.appendChild(dayHeader);
                            });

                            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

                            for (let i = 0; i < firstDay; i++) {
                                const emptyCell = document.createElement('div');
                                emptyCell.className = 'calendar-day empty';
                                calendarGrid.appendChild(emptyCell);
                            }

                            const realToday = new Date();
                            for (let i = 1; i <= lastDate; i++) {
                                const dayCell = document.createElement('div');
                                dayCell.className = 'calendar-day';
                                dayCell.textContent = i;

                                if (i === realToday.getDate() &&
                                    currentMonth === realToday.getMonth() &&
                                    currentYear === realToday.getFullYear()) {
                                    dayCell.classList.add('today');
                                }

                                dayCell.addEventListener('touchstart', (e) => {
                                    e.preventDefault();
                                    const selectedDate = new Date(currentYear, currentMonth, i);
                                    alert(`Selected date: ${selectedDate.toDateString()}`);
                                });

                                calendarGrid.appendChild(dayCell);
                            }
                        };

                        prevMonthBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            currentMonth--;
                            if (currentMonth < 0) {
                                currentMonth = 11;
                                currentYear--;
                            }
                            renderCalendar();
                        });

                        nextMonthBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            currentMonth++;
                            if (currentMonth > 11) {
                                currentMonth = 0;
                                currentYear++;
                            }
                            renderCalendar();
                        });

                        todayBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            const today = new Date();
                            currentMonth = today.getMonth();
                            currentYear = today.getFullYear();
                            renderCalendar();
                        });

                        renderCalendar();
                    }
                });

                return window;
            },

            createSettingsWindow() {
                const content = `
                    <div class="settings-content">
                        <div class="setting-group">
                            <h4>Appearance</h4>
                            <div>
                                <label for="theme-select">Theme:</label>
                                <div class="themes-container">
                                    <div class="theme-preview" data-theme="matrix-1" style="background-color: #000; color: #39FF14; border-color: #39FF14;">
                                        Matrix
                                    </div>
                                    <div class="theme-preview" data-theme="blue-sky" style="background-color: #001933; color: #00AAFF; border-color: #00AAFF;">
                                        Blue Sky
                                    </div>
                                    <div class="theme-preview" data-theme="midnight-purple" style="background-color: #1A0033; color: #CC66FF; border-color: #CC66FF;">
                                        Purple
                                    </div>
                                    <div class="theme-preview" data-theme="amber-tech" style="background-color: #000; color: #FF0000; border-color: #FF0000;">
                                        Matrix red
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <h4>System Information</h4>
                            <p>OS Version: 2.0 Mobile</p>
                            <p>Storage Used: <span id="storage-used">Calculating...</span></p>
                            <button id="reset-system">Reset System</button>
                        </div>
                    </div>
                `;

                const window = this.WindowManager.create('Settings', content, 'settings', {
                    onload: (window) => {
                        const themeButtons = window.querySelectorAll('.theme-preview');
                        const storageUsed = window.querySelector('#storage-used');
                        const resetButton = window.querySelector('#reset-system');

                        const calculateStorage = () => {
                            const fsData = localStorage.getItem('filesystem');
                            const bytes = fsData ? fsData.length : 0;

                            if (bytes < 1024) {
                                storageUsed.textContent = `${bytes} bytes`;
                            } else if (bytes < 1024 * 1024) {
                                storageUsed.textContent = `${(bytes / 1024).toFixed(2)} KB`;
                            } else {
                                storageUsed.textContent = `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
                            }
                        };

                        calculateStorage();

                        themeButtons.forEach(button => {
                            if (button.dataset.theme === this.currentTheme) {
                                button.style.boxShadow = '0 0 8px currentColor';
                            }

                            button.addEventListener('touchstart', (e) => {
                                e.preventDefault();
                                const theme = button.dataset.theme;

                                themeButtons.forEach(btn => {
                                    btn.style.boxShadow = 'none';
                                });

                                button.style.boxShadow = '0 0 8px currentColor';

                                document.documentElement.className = theme;
                                this.currentTheme = theme;

                                const settingsData = JSON.parse(this.FileSystem.read('system/settings.json') || '{}');
                                settingsData.theme = theme;
                                this.FileSystem.write('system/settings.json', JSON.stringify(settingsData));
                            });
                        });

                        resetButton.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            if (confirm('Are you sure you want to reset the system? All data will be lost.')) {
                                localStorage.clear();
                                alert('System reset complete. The page will now reload.');
                                location.reload();
                            }
                        });
                    }
                });

                return window;
            },

            createAboutWindow() {
                const content = `
                    <div class="about-content">
                        <div class="about-logo">SC<span class="spinning-o">o</span>s</div>
                        <div class="about-info">
                            <p><strong>Version:</strong> 2.0 Mobile</p>
                            <p><strong>Released:</strong> August 2025</p>
                            <p>SCos is a simulated computer operating system that runs in your browser.</p>
                        </div>
                        <div>
                            <p>Features:</p>
                            <ul style="text-align: left; margin: 10px 0 10px 30px;">
                                <li>Fully functional file system</li>
                                <li>Window management with drag, resize, and minimize</li>
                                <li>Terminal with basic commands</li>
                                <li>Text editor</li>
                                <li>Web browser</li>
                                <li>Calendar application</li>
                                <li>Customizable themes</li>
                            </ul>
                        </div>
                    </div>
                `;

                const window = this.WindowManager.create('About SCos', content, 'about');

                return window;
            },

            createAIWindow() {
                const content = `
                    <div class="ai-content" id="ai-chat-history">
                        <div class="ai-message assistant">Hello, I am SCos AI. How can I assist you today?</div>
                    </div>
                    <div class="ai-input-container">
                        <input type="text" id="ai-input" placeholder="Ask me anything...">
                        <button id="ai-send-button"><i class="fas fa-paper-plane"></i></button>
                    </div>
                `;

                const window = this.WindowManager.create('AI Assistant', content, 'ai', {
                    onload: (window) => {
                        const chatHistory = window.querySelector('#ai-chat-history');
                        const input = window.querySelector('#ai-input');
                        const sendButton = window.querySelector('#ai-send-button');

                        const addMessage = (text, type) => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `ai-message ${type}`;
                            messageDiv.textContent = text;
                            chatHistory.appendChild(messageDiv);
                            chatHistory.scrollTop = chatHistory.scrollHeight;
                        };

                        const handleSend = async () => {
                            const userMessage = input.value;
                            if (!userMessage.trim()) return;

                            addMessage(userMessage, 'user');
                            input.value = '';

                            const assistantResponse = await this.getAIResponse(userMessage);
                            addMessage(assistantResponse, 'assistant');
                        };

                        sendButton.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            handleSend();
                        });
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                handleSend();
                            }
                        });
                    }
                });
                return window;
            },

            createAppStoreWindow() {
                const apps = [
                    { name: 'calculator', title: 'Calculator', icon: 'fas fa-calculator', description: 'A scientific calculator using math.js.', size: 2500 },
                    { name: 'imageviewer', title: 'Image Viewer', icon: 'fas fa-image', description: 'View local image files.', size: 1000 },
                    { name: 'weather', title: 'Weather', icon: 'fas fa-cloud-sun', description: 'Check live weather for any city.', size: 3000 },
                    { name: 'notes', title: 'Notes', icon: 'fas fa-sticky-note', description: 'Create and save notes to local storage.', size: 500 },
                    { name: 'timerstopwatch', title: 'Timer/Stopwatch', icon: 'fas fa-stopwatch', description: 'A utility for timing and counting down.', size: 800 },
                    { name: 'tictactoe', title: 'Tic-Tac-Toe', icon: 'fas fa-gamepad', description: 'The classic game of Tic-Tac-Toe.', size: 1500 }
                ];

                const content = `
                    <div class="appstore-content">
                        ${apps.map(app => {
                            const isInstalled = this.installedApps.some(a => a.name === app.name);
                            return `
                                <div class="appstore-app" data-app="${app.name}">
                                    <i class="${app.icon} appstore-app-icon"></i>
                                    <div class="appstore-app-details">
                                        <h4>${app.title}</h4>
                                        <p>${app.description}</p>
                                    </div>
                                    ${isInstalled
                                        ? `<button disabled class="installed-button">Installed</button>`
                                        : `<button class="install-button" data-app-name="${app.name}" data-app-size="${app.size}">Install</button>`
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                const window = this.WindowManager.create('App Store', content, 'appstore', {
                    onload: (window) => {
                        const installButtons = window.querySelectorAll('.install-button');
                        installButtons.forEach(button => {
                            button.addEventListener('touchstart', async (e) => {
                                e.preventDefault();
                                const appName = e.target.dataset.appName;
                                const appSize = parseInt(e.target.dataset.appSize);
                                const appToInstall = apps.find(app => app.name === appName);
                                if (appToInstall) {
                                    await this.installApp(appToInstall, e.target);
                                }
                            });
                        });
                    }
                });
                return window;
            },

            createCalculatorWindow() {
                const content = `
                    <div class="calculator-content">
                        <div class="calculator-display" id="calc-display">0</div>
                        <div class="calculator-buttons">
                            <button class="calc-button clear">AC</button>
                            <button class="calc-button operator">+/-</button>
                            <button class="calc-button operator">%</button>
                            <button class="calc-button operator">/</button>
                            <button class="calc-button number">7</button>
                            <button class="calc-button number">8</button>
                            <button class="calc-button number">9</button>
                            <button class="calc-button operator">*</button>
                            <button class="calc-button number">4</button>
                            <button class="calc-button number">5</button>
                            <button class="calc-button number">6</button>
                            <button class="calc-button operator">-</button>
                            <button class="calc-button number">1</button>
                            <button class="calc-button number">2</button>
                            <button class="calc-button number">3</button>
                            <button class="calc-button operator">+</button>
                            <button class="calc-button number zero">0</button>
                            <button class="calc-button dot">.</button>
                            <button class="calc-button equals">=</button>
                        </div>
                    </div>
                `;
                this.WindowManager.create('Calculator', content, 'calculator', {
                    onload: (window) => {
                        const display = window.querySelector('#calc-display');
                        const buttons = window.querySelectorAll('.calc-button');
                        let expression = '';

                        const updateDisplay = () => {
                            display.textContent = expression || '0';
                        };

                        const evaluateExpression = () => {
                            try {
                                let result = math.evaluate(expression);
                                expression = String(result);
                                updateDisplay();
                            } catch (e) {
                                display.textContent = 'Error';
                                expression = '';
                            }
                        };

                        buttons.forEach(button => {
                            button.addEventListener('touchstart', (e) => {
                                e.preventDefault();
                                const value = e.target.textContent;

                                if (value === 'AC') {
                                    expression = '';
                                } else if (value === '=') {
                                    evaluateExpression();
                                } else if (value === '+/-') {
                                    if (expression !== '') {
                                        expression = `(-1)*(${expression})`;
                                    }
                                } else if (value === 'C') {
                                    expression = expression.slice(0, -1);
                                } else {
                                    expression += value;
                                }
                                updateDisplay();
                            });
                        });
                    }
                });
            },

            createImageViewerWindow() {
                const content = `
                    <div class="image-viewer-content">
                        <div class="file-input-container">
                            <label for="image-file-input">
                                <i class="fas fa-file-upload"></i> Choose Image
                            </label>
                            <input type="file" id="image-file-input" accept="image/*">
                        </div>
                        <img id="image-preview" style="display: none;">
                    </div>
                `;
                this.WindowManager.create('Image Viewer', content, 'imageviewer', {
                    onload: (window) => {
                        const fileInput = window.querySelector('#image-file-input');
                        const imagePreview = window.querySelector('#image-preview');

                        fileInput.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    imagePreview.src = event.target.result;
                                    imagePreview.style.display = 'block';
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                    }
                });
            },

            createNotesAppWindow() {
                const content = `
                    <div class="notes-content">
                        <div class="notes-toolbar">
                            <button id="add-note"><i class="fas fa-plus"></i> Add Note</button>
                        </div>
                        <ul id="notes-list"></ul>
                        <div id="note-editor-container" style="display:none; flex-direction:column; flex-grow:1;">
                            <textarea id="note-editor" class="notes-editor"></textarea>
                            <div class="notes-toolbar">
                                <button id="save-note">Save</button>
                                <button id="delete-note">Delete</button>
                                <button id="close-note">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                this.WindowManager.create('Notes', content, 'notes', {
                    onload: (window) => {
                        const notesList = window.querySelector('#notes-list');
                        const addNoteBtn = window.querySelector('#add-note');
                        const editorContainer = window.querySelector('#note-editor-container');
                        const editor = window.querySelector('#note-editor');
                        const saveNoteBtn = window.querySelector('#save-note');
                        const deleteNoteBtn = window.querySelector('#delete-note');
                        const closeNoteBtn = window.querySelector('#close-note');
                        let currentNoteId = null;

                        const loadNotes = () => {
                            notesList.innerHTML = '';
                            const notes = JSON.parse(localStorage.getItem('notes') || '[]');
                            notes.forEach(note => {
                                const li = document.createElement('li');
                                li.className = 'note-item';
                                li.dataset.id = note.id;
                                li.textContent = note.title;
                                li.addEventListener('touchstart', () => openNote(note.id));
                                notesList.appendChild(li);
                            });
                        };

                        const openNote = (id) => {
                            const notes = JSON.parse(localStorage.getItem('notes') || '[]');
                            const note = notes.find(n => n.id === id);
                            if (note) {
                                currentNoteId = id;
                                notesList.style.display = 'none';
                                addNoteBtn.style.display = 'none';
                                editorContainer.style.display = 'flex';
                                editor.value = note.content;
                                editor.focus();
                            }
                        };

                        const saveNote = () => {
                            let notes = JSON.parse(localStorage.getItem('notes') || '[]');
                            const content = editor.value;
                            const title = content.split('\n')[0].substring(0, 30) || 'Untitled Note';

                            if (currentNoteId) {
                                const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                                if (noteIndex !== -1) {
                                    notes[noteIndex] = { id: currentNoteId, title: title, content: content };
                                }
                            } else {
                                const newId = Date.now();
                                notes.push({ id: newId, title: title, content: content });
                            }
                            localStorage.setItem('notes', JSON.stringify(notes));
                            loadNotes();
                            closeNote();
                        };

                        const deleteNote = () => {
                            if (currentNoteId && confirm('Are you sure you want to delete this note?')) {
                                let notes = JSON.parse(localStorage.getItem('notes') || '[]');
                                notes = notes.filter(n => n.id !== currentNoteId);
                                localStorage.setItem('notes', JSON.stringify(notes));
                                loadNotes();
                                closeNote();
                            }
                        };

                        const closeNote = () => {
                            currentNoteId = null;
                            editor.value = '';
                            notesList.style.display = 'block';
                            addNoteBtn.style.display = 'block';
                            editorContainer.style.display = 'none';
                        };

                        addNoteBtn.addEventListener('touchstart', () => {
                            currentNoteId = null;
                            editor.value = '';
                            notesList.style.display = 'none';
                            addNoteBtn.style.display = 'none';
                            editorContainer.style.display = 'flex';
                            editor.focus();
                        });
                        saveNoteBtn.addEventListener('touchstart', saveNote);
                        deleteNoteBtn.addEventListener('touchstart', deleteNote);
                        closeNoteBtn.addEventListener('touchstart', closeNote);

                        loadNotes();
                    }
                });
            },

            createTimerStopwatchWindow() {
                const content = `
                    <div class="timer-stopwatch-content">
                        <div id="timer-stopwatch-display">00:00:00</div>
                        <div class="timer-stopwatch-controls">
                            <button id="start-btn">Start</button>
                            <button id="pause-btn" style="display:none;">Pause</button>
                            <button id="reset-btn">Reset</button>
                        </div>
                    </div>
                `;
                this.WindowManager.create('Timer & Stopwatch', content, 'timerstopwatch', {
                    onload: (window) => {
                        const display = window.querySelector('#timer-stopwatch-display');
                        const startBtn = window.querySelector('#start-btn');
                        const pauseBtn = window.querySelector('#pause-btn');
                        const resetBtn = window.querySelector('#reset-btn');

                        let startTime;
                        let elapsedTime = 0;
                        let timerInterval;

                        const formatTime = (ms) => {
                            const hours = Math.floor(ms / (1000 * 60 * 60));
                            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((ms % (1000 * 60)) / 1000);

                            return [hours, minutes, seconds]
                                .map(v => v < 10 ? '0' + v : v)
                                .join(':');
                        };

                        const startStopwatch = () => {
                            startTime = Date.now() - elapsedTime;
                            timerInterval = setInterval(() => {
                                elapsedTime = Date.now() - startTime;
                                display.textContent = formatTime(elapsedTime);
                            }, 1000);
                            startBtn.style.display = 'none';
                            pauseBtn.style.display = 'inline';
                        };

                        const pauseStopwatch = () => {
                            clearInterval(timerInterval);
                            startBtn.textContent = 'Resume';
                            startBtn.style.display = 'inline';
                            pauseBtn.style.display = 'none';
                        };

                        const resetStopwatch = () => {
                            clearInterval(timerInterval);
                            elapsedTime = 0;
                            display.textContent = '00:00:00';
                            startBtn.textContent = 'Start';
                            startBtn.style.display = 'inline';
                            pauseBtn.style.display = 'none';
                        };

                        startBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            startStopwatch();
                        });
                        pauseBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            pauseStopwatch();
                        });
                        resetBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            resetStopwatch();
                        });
                    }
                });
            },

            createWeatherAppWindow() {
                const content = `
                    <div id="weather-app-container" class="weather-app-content">
                        <h2 id="weather-city-name">Weather App</h2>
                        <input type="text" id="weather-city-input" placeholder="Enter city name...">
                        <button id="get-weather-btn">Get Weather</button>
                        <div id="weather-data" style="display:none;">
                            <i id="weather-icon" class="fas fa-question weather-icon"></i>
                            <div id="weather-temp" class="weather-temp"></div>
                            <p id="weather-description"></p>
                        </div>
                    </div>
                `;
                this.WindowManager.create('Weather', content, 'weather', {
                    onload: (window) => {
                        const cityInput = window.querySelector('#weather-city-input');
                        const getWeatherBtn = window.querySelector('#get-weather-btn');
                        const weatherDataEl = window.querySelector('#weather-data');
                        const cityNameEl = window.querySelector('#weather-city-name');
                        const tempEl = window.querySelector('#weather-temp');
                        const descEl = window.querySelector('#weather-description');
                        const iconEl = window.querySelector('#weather-icon');

                        const fetchWeather = async (city) => {
                            // Using a free API from a public source to avoid key issues
                            const url = `https://goweather.herokuapp.com/weather/${city}`;

                            try {
                                const response = await fetch(url);
                                const data = await response.json();

                                if (data.temperature) {
                                    cityNameEl.textContent = city;
                                    tempEl.textContent = `${data.temperature}`;
                                    descEl.textContent = data.description;
                                    weatherDataEl.style.display = 'block';

                                    // Mapping descriptions to font awesome icons
                                    const description = data.description.toLowerCase();
                                    let iconClass = "fa-question"; // Default icon

                                    if (description.includes("sunny")) iconClass = "fa-sun";
                                    else if (description.includes("rain")) iconClass = "fa-cloud-showers-heavy";
                                    else if (description.includes("cloud")) iconClass = "fa-cloud";
                                    else if (description.includes("storm")) iconClass = "fa-bolt";
                                    else if (description.includes("snow")) iconClass = "fa-snowflake";
                                    else if (description.includes("wind")) iconClass = "fa-wind";

                                    iconEl.className = `fas ${iconClass} weather-icon`;
                                } else {
                                    alert('City not found. Please try again.');
                                }
                            } catch (error) {
                                console.error(error);
                                alert('Error fetching weather data.');
                            }
                        };

                        getWeatherBtn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            const city = cityInput.value;
                            if (city) {
                                fetchWeather(city);
                            }
                        });
                    }
                });
            },

            createTicTacToeWindow() {
                const content = `
                    <div class="tic-tac-toe-content" id="tictactoe-board">
                        <div class="tic-tac-toe-cell" data-index="0"></div>
                        <div class="tic-tac-toe-cell" data-index="1"></div>
                        <div class="tic-tac-toe-cell" data-index="2"></div>
                        <div class="tic-tac-toe-cell" data-index="3"></div>
                        <div class="tic-tac-toe-cell" data-index="4"></div>
                        <div class="tic-tac-toe-cell" data-index="5"></div>
                        <div class="tic-tac-toe-cell" data-index="6"></div>
                        <div class="tic-tac-toe-cell" data-index="7"></div>
                        <div class="tic-tac-toe-cell" data-index="8"></div>
                    </div>
                `;
                this.WindowManager.create('Tic-Tac-Toe', content, 'tictactoe', {
                    onload: (window) => {
                        const board = window.querySelector('#tictactoe-board');
                        const cells = board.querySelectorAll('.tic-tac-toe-cell');
                        let currentPlayer = 'X';
                        let gameActive = true;
                        let gameState = ['', '', '', '', '', '', '', '', ''];

                        const winningConditions = [
                            [0, 1, 2], [3, 4, 5], [6, 7, 8],
                            [0, 3, 6], [1, 4, 7], [2, 5, 8],
                            [0, 4, 8], [2, 4, 6]
                        ];

                        const checkWin = () => {
                            let roundWon = false;
                            for (let i = 0; i < winningConditions.length; i++) {
                                const [a, b, c] = winningConditions[i];
                                if (gameState[a] && gameState[a] === gameState[b] && gameState[a] === gameState[c]) {
                                    roundWon = true;
                                    break;
                                }
                            }

                            if (roundWon) {
                                alert(`Player ${currentPlayer} has won!`);
                                gameActive = false;
                                return;
                            }

                            if (!gameState.includes('')) {
                                alert('Game is a draw!');
                                gameActive = false;
                            }
                        };

                        const handleCellClick = (event) => {
                            const clickedCell = event.target;
                            const clickedCellIndex = parseInt(clickedCell.getAttribute('data-index'));

                            if (gameState[clickedCellIndex] !== '' || !gameActive) {
                                return;
                            }

                            gameState[clickedCellIndex] = currentPlayer;
                            clickedCell.textContent = currentPlayer;

                            checkWin();
                            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                        };

                        cells.forEach(cell => cell.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            handleCellClick(e);
                        }));
                    }
                });
            },

            async getAIResponse(prompt) {
                try {
                    const response = await fetch("https://api-inference.huggingface.co/models/deepseek-ai/deepseek-coder-v2-instruct", {
                        headers: { Authorization: `Bearer ${this.aiAPIKey}` },
                        method: "POST",
                        body: JSON.stringify({
                            inputs: `You are an AI assistant in a simulated operating system called SCos. Your responses should be short, concise, and helpful, and you should act as if you are part of the system.
User: ${prompt}
AI:`
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result && result.length > 0 && result[0].generated_text) {
                        return result[0].generated_text.replace(/^User:.*?AI:/s, '').trim();
                    } else {
                        return "I'm sorry, I couldn't process that request.";
                    }
                } catch (error) {
                    console.error("AI API Error:", error);
                    return "Sorry, I am having trouble connecting to the AI service. Please try again later.";
                }
            },

            applyTheme(theme) {
                document.documentElement.className = theme;
                this.currentTheme = theme;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            System.init();
        });
    </script>
</body>
</html>
