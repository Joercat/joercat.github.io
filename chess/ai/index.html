<!DOCTYPE html>
<html>
<head>
    <title>Chess vs Stockfish AI</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        .container {max-width: 1200px;margin: 0 auto;padding: 20px;display: flex;flex-wrap: wrap;justify-content: center;}
        .game-info {text-align: center;width: 100%;margin-bottom: 20px;}
        .board-container {display: flex;gap: 20px;}
        #board {width: 400px;}
        .side-panel {width: 200px;padding: 20px;background: #f5f5f5;border-radius: 8px;}
        .captured-pieces {margin: 10px 0;min-height: 50px;}
        .captured-pieces img {width: 30px;height: 30px;}
        #moveHistory {height: 300px;overflow-y: auto;border: 1px solid #ddd;padding: 10px;margin-top: 10px;}
        button {padding: 10px;margin: 10px;font-size: 16px;cursor: pointer;}
        #status {font-size: 18px;font-weight: bold;margin-top: 10px;}
        .move-row {display: flex;margin: 5px 0;}
        .move-number {width: 30px;}
        .move {flex: 1;padding: 0 5px;}
        .highlight-square {box-shadow: inset 0 0 3px 3px yellow;}
        .selected-square {box-shadow: inset 0 0 3px 3px blue;}
        #aiSettings {margin: 20px 0;text-align: center;}
        #eloRating {width: 100px;padding: 5px;}
        select, input {padding: 5px;margin: 5px;}
    </style>
</head>
<body>
    <div class="container">
        <div class="game-info">
            <h1>Chess vs Stockfish AI</h1>
            <div id="aiSettings">
                <label for="eloRating">AI ELO Rating (500-3500):</label>
                <input type="number" id="eloRating" min="500" max="3500" step="100" value="1500">
                <label for="playerColor">Play as:</label>
                <select id="playerColor">
                    <option value="white">White</option>
                    <option value="black">Black</option>
                </select>
                <button id="newGame">New Game</button>
            </div>
            <p id="status"></p>
            <p id="thinking" style="display:none">AI is thinking...</p>
        </div>
        <div class="board-container">
            <div class="side-panel">
                <h3>Captured White Pieces</h3>
                <div id="capturedBlack" class="captured-pieces"></div>
                <h3>Move History</h3>
                <div id="moveHistory"></div>
            </div>
            <div id="board"></div>
            <div class="side-panel">
                <h3>Captured Black Pieces</h3>
                <div id="capturedWhite" class="captured-pieces"></div>
            </div>
        </div>
    </div>

    <audio id="moveSound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAADAAAGhgBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr///////////////////////////////////////////8AAAAATGF2YzU4LjU0AAAAAAAAAAAAAAAAJAAAAAAAAAAAAoZxhxX2AAAAAAAAAAAAAAAAAAAA//tQxAAACVDlIgQwYgEjmWc/PCAAAFBHAAAAAAA0kBIAAAEkAAAAACEkBIAAAEkAAAAACQAAP/qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xDE1gPAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqg==" preload="auto"></audio>
    <audio id="captureSound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAADAAAGhgBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr///////////////////////////////////////////8AAAAATGF2YzU4LjU0AAAAAAAAAAAAAAAAJAAAAAAAAAAAAoZxhxX2AAAAAAAAAAAAAAAAAAAA//tQxAAACZjpQgQwYgEvnSn/PCAAAPgnAAAAAAAA0kAIAAAEkAAAAABpIAQAAAJIAAAAABIAAH/6qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EMTWg8AAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" preload="auto"></audio>

    <script>
        let board = null;
        let game = new Chess();
        let moveHistory = [];
        let capturedPieces = { w: [], b: [] };
        let selectedSquare = null;
        let isPlayerTurn = true;
        let playerColor = 'white';
        let stockfish = new Worker('https://stockfish.js.org/stockfish.js');

        function onDragStart(source, piece, position, orientation) {
            if (!isPlayerTurn || game.game_over()) return false;
            if ((playerColor === 'white' && piece.search(/^b/) !== -1) ||
                (playerColor === 'black' && piece.search(/^w/) !== -1)) {
                return false;
            }
            return true;
        }

        function onDrop(source, target) {
            const move = makeMove(source, target);
            if (move === null) return 'snapback';
            
            if (!game.game_over()) {
                setTimeout(makeAIMove, 250);
            }
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        stockfish.onmessage = function(event) {
            if (typeof event.data !== 'string') return;
            
            const message = event.data;
            if (message.startsWith('bestmove')) {
                const move = message.split(' ')[1];
                if (move) {
                    const result = game.move(move, { sloppy: true });
                    if (result) {
                        board.position(game.fen());
                        const isCapture = result.captured !== undefined;
                        playSound(isCapture ? 'capture' : 'move');
                        updateStatus();
                        updateCapturedPieces();
                        updateMoveHistory(game.history()[game.history().length - 1]);
                        isPlayerTurn = true;
                    }
                }
                $('#thinking').hide();
            }
        };

        function setSkillLevel(elo) {
            const minElo = 500;
            const maxElo = 3500;
            const skill = Math.round(((elo - minElo) / (maxElo - minElo)) * 20);
            stockfish.postMessage('setoption name Skill Level value ' + skill);
        }

        function makeAIMove() {
            $('#thinking').show();
            isPlayerTurn = false;
            setSkillLevel(parseInt($('#eloRating').val()));
            stockfish.postMessage('position fen ' + game.fen());
            stockfish.postMessage('go movetime 1000');
        }

        function playSound(type) {
            const sound = document.getElementById(type === 'capture' ? 'captureSound' : 'moveSound');
            sound.currentTime = 0;
            sound.play();
        }

        function updateCapturedPieces() {
            const positions = game.board();
            const currentPieces = { w: {}, b: {} };
            'prnbqk'.split('').forEach(piece => {
                currentPieces.w[piece] = 0;
                currentPieces.b[piece] = 0;
            });

            positions.forEach(row => {
                if (row) {
                    row.forEach(piece => {
                        if (piece) {
                            currentPieces[piece.color][piece.type]++;
                        }
                    });
                }
            });

            const initialCounts = { p: 8, r: 2, n: 2, b: 2, q: 1, k: 1 };
            capturedPieces = { w: [], b: [] };

            ['w', 'b'].forEach(color => {
                Object.entries(initialCounts).forEach(([piece, count]) => {
                    const captured = count - (currentPieces[color][piece] || 0);
                    for (let i = 0; i < captured; i++) {
                        capturedPieces[color].push(piece);
                    }
                });
            });

            $('#capturedWhite').html(capturedPieces.w.map(p =>
                `<img src="https://chessboardjs.com/img/chesspieces/wikipedia/w${p.toUpperCase()}.png" width="30" height="30">`
            ).join(''));
            $('#capturedBlack').html(capturedPieces.b.map(p =>
                `<img src="https://chessboardjs.com/img/chesspieces/wikipedia/b${p.toUpperCase()}.png" width="30" height="30">`
            ).join(''));
        }

        function updateMoveHistory(move) {
            moveHistory.push(move);
            const moveHistoryDiv = $('#moveHistory');
            let html = '';
            for (let i = 0; i < moveHistory.length; i += 2) {
                html += `<div class="move-row">
                    <span class="move-number">${Math.floor(i/2) + 1}.</span>
                    <span class="move">${moveHistory[i]}</span>
                    <span class="move">${moveHistory[i+1] || ''}</span>
                </div>`;
            }
            moveHistoryDiv.html(html);
            moveHistoryDiv.scrollTop(moveHistoryDiv[0].scrollHeight);
        }

        function makeMove(from, to) {
            const move = game.move({
                from: from,
                to: to,
                promotion: 'q'
            });

            if (move) {
                const isCapture = move.captured !== undefined;
                playSound(isCapture ? 'capture' : 'move');
                updateStatus();
                updateCapturedPieces();
                updateMoveHistory(game.history()[game.history().length - 1]);
            }

            return move;
        }

        function updateStatus() {
            let status = '';
            if (game.in_checkmate()) {
                status = game.turn() === 'w' ? 'Game Over - Black Wins!' : 'Game Over - White Wins!';
            } else if (game.in_draw()) {
                status = 'Game Over - Draw!';
            } else {
                status = game.turn() === 'w' ? 'White to move' : 'Black to move';
                if (game.in_check()) {
                    status += ' - CHECK!';
                }
            }
            $('#status').text(status);
        }

        function initGame() {
            game = new Chess();
            moveHistory = [];
            capturedPieces = { w: [], b: [] };
            playerColor = $('#playerColor').val();
            isPlayerTurn = playerColor === 'white';

            const config = {
                draggable: true,
                position: 'start',
                orientation: playerColor,
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };

            if (board) {
                board.destroy();
            }
            
            board = Chessboard('board', config);
            $(window).resize(() => board.resize());

            stockfish.postMessage('ucinewgame');
            setSkillLevel(parseInt($('#eloRating').val()));
            
            updateStatus();
            updateCapturedPieces();
            $('#moveHistory').empty();
            $('#thinking').hide();

            if (!isPlayerTurn) {
                setTimeout(makeAIMove, 500);
            }
        }

        $(document).ready(function() {
            initGame();
            $('#newGame').click(initGame);
            $('#playerColor').change(initGame);
        });
    </script>
</body>
</html>
