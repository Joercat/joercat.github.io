<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olive Delights</title>
    <link rel="icon" type="image/png" href="/kanye.png">
    <style>#ui,.menu-overlay{position:fixed;top:0;left:0}#stamina-bar,#ui,.menu-overlay{height:100%;width:100%}#hud-coins,.coins-display{font-size:18px;color:gold}#powerups-display,#shield-indicator,#stamina-container,#warning{left:50%;transform:translateX(-50%)}#hud-coins,#minimap,#timer{position:absolute;top:20px}#fear-overlay,#freeze-overlay,#ui,.vignette{pointer-events:none}#minimap,#pause-screen{background:rgba(0,0,0,.9)}*{margin:0;padding:0;box-sizing:border-box}body{overflow:hidden;background:#000;font-family:'Courier New',monospace}.menu-overlay{background:linear-gradient(135deg,#1a1a2e,#0f0f23);display:flex;justify-content:center;align-items:center;flex-direction:column;z-index:300}.menu-overlay.hidden,.tab-content{display:none}#start-screen h1{color:gold;font-size:48px;text-shadow:0 0 30px #ff8c00;margin-bottom:10px}#start-screen h2{color:#999;font-size:20px;margin-bottom:20px}.menu-section{background:rgba(0,0,0,.5);padding:15px 25px;border-radius:8px;margin:10px 0;text-align:center}.menu-section h3{color:gold;margin-bottom:10px}.menu-section label,.menu-section p{color:#aaa;font-size:13px;line-height:1.6}.menu-btn{padding:15px 40px;font-size:18px;margin:5px;background:linear-gradient(135deg,#ff8c00,#ff4500);color:#fff;border:none;cursor:pointer;font-family:inherit;border-radius:4px}.menu-btn:hover{transform:scale(1.05)}.menu-btn.secondary{background:linear-gradient(135deg,#444,#333)}.menu-btn.small{padding:8px 20px;font-size:14px}.coins-display{margin:10px 0}.highscores{color:#4ade80;font-size:14px}.highscores span{display:block;margin:3px 0}.settings-row{display:flex;align-items:center;justify-content:space-between;margin:8px 0;color:#aaa}.settings-row input,.settings-row select{background:#333;color:#fff;border:1px solid #555;padding:5px 10px;border-radius:4px}.shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}.shop-item{background:rgba(255,255,255,.1);padding:10px;border-radius:8px;text-align:center}.shop-item img{width:48px;height:48px;image-rendering:pixelated}.shop-item.owned{border:2px solid #4ade80}.shop-item.selected{border:2px solid gold;box-shadow:0 0 10px gold}.upgrade-item{background:rgba(255,255,255,.05);padding:8px;margin:5px 0;border-radius:4px;display:flex;justify-content:space-between;align-items:center}.upgrade-item.owned{background:rgba(74,222,128,.2)}.tab-buttons{display:flex;gap:5px;margin-bottom:15px}.tab-btn{padding:8px 15px;background:#333;color:#aaa;border:none;cursor:pointer;border-radius:4px}.tab-btn.active{background:#ff8c00;color:#fff}.tab-content.active{display:block}#ui{z-index:100}#crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:4px;height:4px;background:rgba(255,255,255,.8);border-radius:50%;box-shadow:0 0 4px #fff}#stamina-container{position:absolute;bottom:30px;width:200px;height:8px;background:rgba(0,0,0,.8);border:1px solid rgba(255,255,255,.3);border-radius:4px}#stamina-bar{background:linear-gradient(90deg,#4ade80,#22c55e);border-radius:3px;transition:width .1s}#stamina-bar.infinite{background:linear-gradient(90deg,#fbbf24,#f59e0b);animation:.3s infinite alternate pulse}#stamina-bar.boosted{background:linear-gradient(90deg,#f472b6,#ec4899)}@keyframes pulse{from{opacity:.7}to{opacity:1}}#hud-coins{left:120px}#timer{left:20px;color:#fff;font-size:20px}#warning{position:absolute;top:80px;color:#f44;font-size:24px;opacity:0;text-shadow:0 0 20px red}#shield-indicator{position:absolute;top:120px;color:#4ade80;font-size:18px;opacity:0}#pickup-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,50px);color:#4ade80;font-size:20px;opacity:0;text-shadow:0 0 10px #000;transition:opacity .3s}#powerups-display{position:absolute;bottom:60px;display:flex;gap:15px}.powerup-slot{width:50px;height:50px;background:rgba(0,0,0,.7);border:2px solid rgba(255,255,255,.3);border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative}#death-screen,#fear-overlay,#freeze-overlay,#pause-screen,.vignette{position:fixed;top:0;left:0;width:100%;height:100%}.powerup-slot.active{border-color:#4ade80;box-shadow:0 0 10px #4ade80}#minimap{right:20px;width:160px;height:160px;border:2px solid rgba(255,255,255,.4);border-radius:4px}#minimap-canvas{width:100%;height:100%}.vignette{z-index:45;background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,.7) 100%)}#fear-overlay{background:rgba(100,0,0,.4);opacity:0;z-index:50}#freeze-overlay{background:rgba(100,200,255,.2);opacity:0;z-index:48}#death-screen{background:rgba(80,0,0,.95);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:200}#death-screen h1{color:#fff;font-size:64px;text-shadow:0 0 30px red;margin-bottom:20px}#death-screen p{color:#fcc;font-size:20px;margin-bottom:10px}#death-screen .coins-earned{color:gold;font-size:24px;margin:15px 0}#pause-screen{display:none;justify-content:center;align-items:center;flex-direction:column;z-index:250}#pause-screen h1{color:#fff;font-size:48px;margin-bottom:20px}</style>
</head>
<body>
    <div id="start-screen" class="menu-overlay">
        <h1>ü´í OLIVE DELIGHTS ü´í</h1>
        <h2>Map based on The Backrooms</h2>
        
        <div class="coins-display">üí∞ Coins: <span id="total-coins">0</span></div>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab('play')">PLAY</button>
            <button class="tab-btn" onclick="showTab('shop')">SHOP</button>
            <button class="tab-btn" onclick="showTab('upgrades')">UPGRADES</button>
            <button class="tab-btn" onclick="showTab('settings')">SETTINGS</button>
        </div>
        
      <div id="tab-play" class="tab-content active">
            <div class="menu-section">
                <h3>üèÜ TOP 3 RUNS</h3>
                <div class="highscores" id="highscores">
                    <span>1. --:--</span>
                    <span>2. --:--</span>
                    <span>3. --:--</span>
                </div>
            </div>
            
            <div class="menu-section">
                <p><strong>CONTROLS:</strong><br>
                WASD - Move | <span id="sprint-key-display">SHIFT</span> - Sprint | SPACE - Jump<br>
                ESC - Pause Menu</p>
            </div>
            
            <div class="menu-section">
                <label><input type="checkbox" id="start-shield-toggle"> Start with Shield (5 coins)</label>
            </div>
            
            <button class="menu-btn" onclick="startGame()">ENTER THE BACKROOMS</button>
        </div>

        <div id="tab-shop" class="tab-content">
            <div class="menu-section">
                <h3>üé≠ KANYE SKINS</h3>
                <div class="shop-grid" id="skin-shop"></div>
            </div>
        </div>

        <div id="tab-upgrades" class="tab-content">
            <div class="menu-section">
                <h3>‚ùÑÔ∏è ICE UPGRADES</h3>
                <div id="ice-upgrades"></div>
            </div>
            <div class="menu-section">
                <h3>‚ö° SPEED UPGRADES</h3>
                <div id="speed-upgrades"></div>
            </div>
            <div class="menu-section">
                <h3>üõ°Ô∏è SHIELD UPGRADES</h3>
                <div id="shield-upgrades"></div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="menu-section">
                <h3>‚öôÔ∏è SETTINGS</h3>
                <div class="settings-row">
                    <label>Sprint Key:</label>
                    <select id="sprint-key-select" onchange="updateSprintKey()">
                        <option value="ShiftLeft">Left Shift</option>
                        <option value="ControlLeft">Left Ctrl</option>
                        <option value="KeyC">R</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label>Mouse Sensitivity:</label>
                    <input type="range" id="sensitivity" min="1" max="10" value="5" onchange="updateSensitivity()">
                </div>
                <div class="settings-row">
                    <label>Music Volume:</label>
                    <input type="range" id="music-volume" min="0" max="100" value="100" onchange="updateMusicVolume()">
                </div>
            </div>
        </div>
    </div>

    <div id="ui">
        <div id="crosshair"></div>
        <div id="stamina-container"><div id="stamina-bar"></div></div>
        <div id="powerups-display">
            <div class="powerup-slot" id="slot-ice"><span style="color:#666;font-size:24px;">‚ùÑÔ∏è</span></div>
            <div class="powerup-slot" id="slot-speed"><span style="color:#666;font-size:24px;">‚ö°</span></div>
            <div class="powerup-slot" id="slot-shield"><span style="color:#666;font-size:24px;">üõ°Ô∏è</span></div>
        </div>
        <div id="warning">‚ö†Ô∏è HE'S CLOSE ‚ö†Ô∏è</div>
        <div id="shield-indicator">üõ°Ô∏è SHIELD ACTIVE</div>
        <div id="timer">0:00</div>
        <div id="hud-coins">üí∞ 0</div>
        <div id="minimap"><canvas id="minimap-canvas"></canvas></div>
        <div id="pickup-msg"></div>
    </div>
    
    <div class="vignette"></div>
    <div id="fear-overlay"></div>
    <div id="freeze-overlay"></div>

    <div id="pause-screen">
        <h1>‚è∏Ô∏è PAUSED</h1>
        <div class="menu-section">
            <div class="settings-row">
                <label>Music Volume:</label>
                <input type="range" id="pause-volume" min="0" max="100" value="100" onchange="updateMusicVolume()">
            </div>
            <div class="settings-row">
                <label>Sensitivity:</label>
                <input type="range" id="pause-sensitivity" min="1" max="10" value="5" onchange="updateSensitivity()">
            </div>
        </div>
        <button class="menu-btn" onclick="resumeGame()">RESUME</button>
        <button class="menu-btn secondary" onclick="quitGame()">QUIT</button>
    </div>

    <div id="death-screen">
        <h1>YOU DIED</h1>
        <p>Kanye caught you...</p>
        <p id="survival-time">Survived: 0:00</p>
        <p class="coins-earned" id="coins-earned">+0 coins</p>
        <button class="menu-btn" onclick="restartGame()">TRY AGAIN</button>
        <button class="menu-btn secondary" onclick="returnToMenu()">MAIN MENU</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>let saveData={coins:0,highscores:[],ownedSkins:["default"],selectedSkin:"default",upgrades:{ice:0,speed:0,shield:0},settings:{sprintKey:"ShiftLeft",sensitivity:5,musicVolume:100}};function loadSaveData(){try{const e=localStorage.getItem("oliveDelights");e&&(saveData={...saveData,...JSON.parse(e)})}catch(e){}updateUI()}function saveSaveData(){try{localStorage.setItem("oliveDelights",JSON.stringify(saveData))}catch(e){}}const SKINS=[{id:"default",name:"Classic Kanye",url:"https://joercat.github.io/kanye.png",cost:0},{id:"kanye2",name:"Alt Kanye",url:"https://joercat.github.io/kanye2.png",cost:100}],UPGRADES={ice:[{level:1,cost:10,desc:"+1 sec freeze"},{level:2,cost:15,desc:"+3 sec freeze"},{level:3,cost:25,desc:"+3 sec freeze + 3 sec half speed"}],speed:[{level:1,cost:10,desc:"+3 sec duration"},{level:2,cost:15,desc:"+5 sec duration"},{level:3,cost:25,desc:"+5 sec + speed boost"}],shield:[{level:1,cost:10,desc:"+1 sec freeze on block"},{level:2,cost:15,desc:"+2 sec freeze on block"},{level:3,cost:25,desc:"2 hits + 2 sec freeze"}]};let scene,camera,renderer,wallTexture,floorTexture,gameStarted=!1,isPaused=!1,isDead=!1,startTime=0,sessionCoins=0,sprintKeyCode="ShiftLeft",mouseSensitivity=.002,musicVolumeMultiplier=1;const player={x:0,y:1.6,z:0,yaw:0,pitch:0,onGround:!0,vy:0,shieldHits:0,infiniteStamina:!1,infiniteStaminaTimer:0,speedBoost:!1,speedBoostTimer:0},kanye={x:0,z:0,vx:0,vz:0,sprite:null,pathTimer:0,path:[],pathIndex:0,frozen:!1,frozenTimer:0,halfSpeed:!1,halfSpeedTimer:0,turnSpeed:3.5,maxSpeed:5.1,currentSkinUrl:""},powerups=[],coins=[],POWERUP_TYPES=["ice","speed","shield"],keys={};let audioCtx,audioBuffer,audioSource,gainNode,isLocked=!1,stamina=100,isSprinting=!1,audioReady=!1,audioPlaying=!1;const CELL=4,GRID_SIZE=25,WALL_H=3.5;let maze=[],walkableCells=[];const textureLoader=new THREE.TextureLoader;function showTab(e){document.querySelectorAll(".tab-content").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".tab-btn").forEach((e=>e.classList.remove("active"))),document.getElementById("tab-"+e).classList.add("active"),event.target.classList.add("active")}function updateUI(){document.getElementById("total-coins").textContent=saveData.coins,document.getElementById("sprint-key-display").textContent=saveData.settings.sprintKey.replace("ShiftLeft","SHIFT").replace("ShiftRight","R-SHIFT").replace("ControlLeft","CTRL").replace("KeyC","C");const e=document.getElementById("highscores");e.innerHTML="";for(let t=0;t<3;t++){const a=saveData.highscores[t],n=document.createElement("span");if(a){const e=Math.floor(a/60),i=Math.floor(a%60);n.textContent=`${t+1}. ${e}:${i.toString().padStart(2,"0")}`}else n.textContent=`${t+1}. --:--`;e.appendChild(n)}const t=document.getElementById("skin-shop");t.innerHTML="",SKINS.forEach((e=>{const a=document.createElement("div");a.className="shop-item",saveData.ownedSkins.includes(e.id)&&a.classList.add("owned"),saveData.selectedSkin===e.id&&a.classList.add("selected"),a.innerHTML=`<img src="${e.url}"><br><small>${e.name}</small><br>`,saveData.ownedSkins.includes(e.id)?saveData.selectedSkin!==e.id?a.innerHTML+=`<button class="menu-btn small" onclick="selectSkin('${e.id}')">SELECT</button>`:a.innerHTML+='<small style="color:#4ade80;">EQUIPPED</small>':a.innerHTML+=`<button class="menu-btn small" onclick="buySkin('${e.id}')">${e.cost} üí∞</button>`,t.appendChild(a)})),["ice","speed","shield"].forEach((e=>{const t=document.getElementById(e+"-upgrades");t.innerHTML="",UPGRADES[e].forEach(((a,n)=>{const i=document.createElement("div");i.className="upgrade-item",saveData.upgrades[e]>=a.level&&i.classList.add("owned"),i.innerHTML=`<span>Lv${a.level}: ${a.desc}</span>`,saveData.upgrades[e]>=a.level?i.innerHTML+='<span style="color:#4ade80;">‚úì</span>':saveData.upgrades[e]===a.level-1?i.innerHTML+=`<button class="menu-btn small" onclick="buyUpgrade('${e}', ${a.level})">${a.cost} üí∞</button>`:i.innerHTML+='<span style="color:#666;">üîí</span>',t.appendChild(i)}))})),document.getElementById("sprint-key-select").value=saveData.settings.sprintKey,document.getElementById("sensitivity").value=saveData.settings.sensitivity,document.getElementById("music-volume").value=saveData.settings.musicVolume,sprintKeyCode=saveData.settings.sprintKey,mouseSensitivity=4e-4*saveData.settings.sensitivity,musicVolumeMultiplier=saveData.settings.musicVolume/100}function buySkin(e){const t=SKINS.find((t=>t.id===e));t&&saveData.coins>=t.cost&&!saveData.ownedSkins.includes(e)&&(saveData.coins-=t.cost,saveData.ownedSkins.push(e),saveData.selectedSkin=e,saveSaveData(),updateUI())}function selectSkin(e){saveData.ownedSkins.includes(e)&&(saveData.selectedSkin=e,saveSaveData(),updateUI())}function buyUpgrade(e,t){const a=UPGRADES[e].find((e=>e.level===t));a&&saveData.coins>=a.cost&&saveData.upgrades[e]===t-1&&(saveData.coins-=a.cost,saveData.upgrades[e]=t,saveSaveData(),updateUI())}function updateSprintKey(){saveData.settings.sprintKey=document.getElementById("sprint-key-select").value,sprintKeyCode=saveData.settings.sprintKey,saveSaveData(),updateUI()}function updateSensitivity(){const e=document.getElementById("sensitivity").value||document.getElementById("pause-sensitivity").value;saveData.settings.sensitivity=parseInt(e),mouseSensitivity=4e-4*saveData.settings.sensitivity,saveSaveData()}function updateMusicVolume(){const e=document.getElementById("music-volume").value||document.getElementById("pause-volume").value;saveData.settings.musicVolume=parseInt(e),musicVolumeMultiplier=saveData.settings.musicVolume/100,saveSaveData()}function loadTextures(e){let t=0;const a=()=>{t++,2===t&&e()};wallTexture=textureLoader.load("https://joercat.github.io/wall.png",a,void 0,a),wallTexture.wrapS=THREE.RepeatWrapping,wallTexture.wrapT=THREE.RepeatWrapping,floorTexture=textureLoader.load("https://joercat.github.io/floor.jpg",a,void 0,a),floorTexture.wrapS=THREE.RepeatWrapping,floorTexture.wrapT=THREE.RepeatWrapping,floorTexture.repeat.set(2*GRID_SIZE,2*GRID_SIZE)}async function initAudio(){try{audioCtx=new(window.AudioContext||window.webkitAudioContext),gainNode=audioCtx.createGain(),gainNode.gain.value=0,gainNode.connect(audioCtx.destination);const e=await fetch("https://joercat.github.io/olive.wav"),t=await e.arrayBuffer();audioBuffer=await audioCtx.decodeAudioData(t),audioReady=!0}catch(e){console.log("Audio failed:",e)}}function setAudioVolume(e){if(!audioReady)return;"suspended"===audioCtx.state&&audioCtx.resume(),!audioPlaying&&e>0&&(audioSource=audioCtx.createBufferSource(),audioSource.buffer=audioBuffer,audioSource.loop=!0,audioSource.connect(gainNode),audioSource.start(),audioPlaying=!0);const t=Math.min(1,e*musicVolumeMultiplier);gainNode&&gainNode.gain.setTargetAtTime(t,audioCtx.currentTime,.1)}function stopAudio(){if(audioSource){try{audioSource.stop()}catch(e){}audioSource=null,audioPlaying=!1}gainNode&&(gainNode.gain.value=0)}function generateMaze(){maze=[];for(let e=0;e<GRID_SIZE;e++){maze[e]=[];for(let t=0;t<GRID_SIZE;t++)maze[e][t]=1}const e=[];for(maze[1][1]=0,e.push({x:1,z:1});e.length>0;){const t=e[e.length-1],a=[{dx:0,dz:-2},{dx:0,dz:2},{dx:-2,dz:0},{dx:2,dz:0}];for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}let n=!1;for(const i of a){const a=t.x+i.dx,s=t.z+i.dz;if(a>0&&a<GRID_SIZE-1&&s>0&&s<GRID_SIZE-1&&1===maze[a][s]){maze[t.x+i.dx/2][t.z+i.dz/2]=0,maze[a][s]=0,e.push({x:a,z:s}),n=!0;break}}n||e.pop()}for(let e=2;e<GRID_SIZE-2;e++)for(let t=2;t<GRID_SIZE-2;t++)if(1===maze[e][t]&&Math.random()<.2){let a=0;0===maze[e-1][t]&&a++,0===maze[e+1][t]&&a++,0===maze[e][t-1]&&a++,0===maze[e][t+1]&&a++,a>=2&&(maze[e][t]=0)}walkableCells=[];for(let e=1;e<GRID_SIZE-1;e++)for(let t=1;t<GRID_SIZE-1;t++)0===maze[e][t]&&walkableCells.push({x:e,z:t})}function gridToWorld(e,t){return{x:(e-GRID_SIZE/2+.5)*CELL,z:(t-GRID_SIZE/2+.5)*CELL}}function worldToGrid(e,t){return{x:Math.floor(e/CELL+GRID_SIZE/2),z:Math.floor(t/CELL+GRID_SIZE/2)}}function isWalkableWorld(e,t,a=.35){const n=[{x:e,z:t},{x:e-a,z:t-a},{x:e+a,z:t-a},{x:e-a,z:t+a},{x:e+a,z:t+a}];for(const e of n){const t=worldToGrid(e.x,e.z);if(t.x<0||t.x>=GRID_SIZE||t.z<0||t.z>=GRID_SIZE)return!1;if(!maze[t.x]||0!==maze[t.x][t.z])return!1}return!0}function isWalkableGrid(e,t){return!(e<0||e>=GRID_SIZE||t<0||t>=GRID_SIZE)&&(maze[e]&&0===maze[e][t])}function buildWorld(){const e=new THREE.MeshBasicMaterial({map:wallTexture}),t=new THREE.MeshBasicMaterial({map:floorTexture}),a=new THREE.MeshBasicMaterial({color:2763306});for(let t=0;t<GRID_SIZE;t++)for(let a=0;a<GRID_SIZE;a++)if(1===maze[t][a]){const n=gridToWorld(t,a),i=new THREE.BoxGeometry(CELL,WALL_H,CELL),s=new THREE.Mesh(i,e);s.position.set(n.x,WALL_H/2,n.z),scene.add(s)}const n=new THREE.PlaneGeometry(GRID_SIZE*CELL,GRID_SIZE*CELL),i=new THREE.Mesh(n,t);i.rotation.x=-Math.PI/2,i.position.y=.01,scene.add(i);const s=new THREE.PlaneGeometry(GRID_SIZE*CELL,GRID_SIZE*CELL),o=new THREE.Mesh(s,a);o.rotation.x=Math.PI/2,o.position.y=WALL_H,scene.add(o),scene.add(new THREE.AmbientLight(16774624,.9))}function findPath(e,t,a,n){if(!isWalkableGrid(e,t)||!isWalkableGrid(a,n))return[];const i=(e,t)=>1e3*e+t,s=[{x:e,z:t,g:0,f:0}],o=new Set,l=new Map,r=new Map;r.set(i(e,t),0);let d=0;for(;s.length>0&&d<2e3;){d++;let e=0;for(let t=1;t<s.length;t++)s[t].f<s[e].f&&(e=t);const t=s.splice(e,1)[0],p=i(t.x,t.z);if(t.x===a&&t.z===n){const e=[];let t=p;for(;l.has(t);)e.unshift({x:Math.floor(t/1e3),z:t%1e3}),t=l.get(t);return e}o.add(p);const u=[{x:t.x+1,z:t.z},{x:t.x-1,z:t.z},{x:t.x,z:t.z+1},{x:t.x,z:t.z-1}];for(const e of u){if(!isWalkableGrid(e.x,e.z))continue;const t=i(e.x,e.z);if(o.has(t))continue;const d=(r.get(p)||0)+1;if(d<(r.get(t)||1/0)){l.set(t,p),r.set(t,d);const i=d+(c=e.x,y=e.z,Math.abs(c-a)+Math.abs(y-n)),o=s.find((t=>t.x===e.x&&t.z===e.z));o?o.f=i:s.push({x:e.x,z:e.z,g:d,f:i})}}}var c,y;return[]}function createKanye(){const e=SKINS.find((e=>e.id===saveData.selectedSkin))?.url||SKINS[0].url;kanye.currentSkinUrl=e,textureLoader.load(e,(e=>{e.magFilter=THREE.NearestFilter,e.minFilter=THREE.NearestFilter;const t=new THREE.SpriteMaterial({map:e});kanye.sprite=new THREE.Sprite(t),kanye.sprite.scale.set(2.5,2.5,1),scene.add(kanye.sprite),kanye.sprite.position.set(kanye.x,1.25,kanye.z)}))}function createPowerups(){powerups.forEach((e=>{e.sprite&&scene.remove(e.sprite)})),powerups.length=0;const e=[...walkableCells].sort((()=>Math.random()-.5)),t={ice:"https://joercat.github.io/ice.png",speed:"https://joercat.github.io/speed.png",shield:"https://joercat.github.io/shield.png"};for(let a=0;a<12&&a<e.length;a++){const n=POWERUP_TYPES[a%3],i=e[a],s=gridToWorld(i.x,i.z);textureLoader.load(t[n],(e=>{e.magFilter=THREE.NearestFilter;const t=new THREE.SpriteMaterial({map:e}),a=new THREE.Sprite(t);a.scale.set(1.2,1.2,1),a.position.set(s.x,.8,s.z),scene.add(a),powerups.push({type:n,x:s.x,z:s.z,sprite:a,collected:!1})}))}}function createCoins(){coins.forEach((e=>{e.sprite&&scene.remove(e.sprite)})),coins.length=0,spawnCoins()}function spawnCoins(){const e=walkableCells.filter((e=>{const t=gridToWorld(e.x,e.z);return!coins.some((e=>!e.collected&&Math.hypot(e.x-t.x,e.z-t.z)<2))})).sort((()=>Math.random()-.5)),t=5-coins.filter((e=>!e.collected)).length;for(let a=0;a<t&&a<e.length;a++){const t=e[a],n=gridToWorld(t.x,t.z);textureLoader.load("https://joercat.github.io/coin.png",(e=>{e.magFilter=THREE.NearestFilter;const t=new THREE.SpriteMaterial({map:e}),a=new THREE.Sprite(t);a.scale.set(.8,.8,1),a.position.set(n.x,.6,n.z),scene.add(a),coins.push({x:n.x,z:n.z,sprite:a,collected:!1})}))}}function spawnEntities(){if(walkableCells.length<10)return;const e=Math.floor(Math.random()*walkableCells.length),t=walkableCells[e],a=gridToWorld(t.x,t.z);player.x=a.x,player.z=a.z,player.y=1.6,player.yaw=0,player.pitch=0,player.vy=0,player.onGround=!0,player.shieldHits=0,player.infiniteStamina=!1,player.speedBoost=!1,document.getElementById("start-shield-toggle").checked&&saveData.coins>=5&&(saveData.coins-=5,player.shieldHits=saveData.upgrades.shield>=3?2:1,document.getElementById("shield-indicator").style.opacity="1",document.getElementById("slot-shield").classList.add("active"),saveSaveData(),updateUI());let n=0,i=walkableCells[0];for(const e of walkableCells){const t=gridToWorld(e.x,e.z),a=Math.hypot(t.x-player.x,t.z-player.z);a>n&&(n=a,i=e)}const s=gridToWorld(i.x,i.z);kanye.x=s.x,kanye.z=s.z,kanye.vx=0,kanye.vz=0,kanye.pathTimer=0,kanye.path=[],kanye.frozen=!1,kanye.halfSpeed=!1,kanye.sprite&&kanye.sprite.position.set(kanye.x,1.25,kanye.z),camera.position.set(player.x,player.y,player.z),createPowerups(),createCoins()}function updatePlayer(e){if(!isLocked||isPaused)return;let t=7.5;player.speedBoost&&(player.speedBoostTimer-=e,t=9,player.speedBoostTimer<=0&&(player.speedBoost=!1));player.infiniteStamina&&(player.infiniteStaminaTimer-=e,player.infiniteStaminaTimer<=0&&(player.infiniteStamina=!1,document.getElementById("stamina-bar").classList.remove("infinite"),document.getElementById("stamina-bar").classList.remove("boosted")));const a=isSprinting&&(keys.KeyW||keys.KeyS||keys.KeyA||keys.KeyD);a&&!player.infiniteStamina?stamina>0&&(stamina=Math.max(0,stamina-20*e)):a||(stamina=Math.min(100,stamina+15*e));const n=a&&(stamina>0||player.infiniteStamina)?t:5;document.getElementById("stamina-bar").style.width=(player.infiniteStamina?100:stamina)+"%";const i=-Math.sin(player.yaw),s=-Math.cos(player.yaw),o=Math.cos(player.yaw),l=-Math.sin(player.yaw);let r=0,d=0;keys.KeyW&&(r+=i,d+=s),keys.KeyS&&(r-=i,d-=s),keys.KeyD&&(r+=o,d+=l),keys.KeyA&&(r-=o,d-=l);const c=Math.hypot(r,d);c>0&&(r=r/c*n,d=d/c*n),keys.Space&&player.onGround&&(player.vy=6,player.onGround=!1),player.vy-=18*e;let y=player.x+r*e,p=player.z+d*e,u=player.y+player.vy*e;isWalkableWorld(y,player.z,.35)||(y=player.x),isWalkableWorld(y,p,.35)||(p=player.z),player.x=y,player.z=p,u<1.6&&(u=1.6,player.vy=0,player.onGround=!0),u>WALL_H-.3&&(u=WALL_H-.3,player.vy=0),player.y=u,camera.position.set(player.x,player.y,player.z),camera.rotation.order="YXZ",camera.rotation.y=player.yaw,camera.rotation.x=player.pitch,checkPowerupCollection(),checkCoinCollection()}function checkPowerupCollection(){for(const e of powerups){if(e.collected)continue;Math.hypot(e.x-player.x,e.z-player.z)<1.5&&(e.collected=!0,e.sprite&&scene.remove(e.sprite),activatePowerup(e.type))}}function activatePowerup(e){const t=document.getElementById("pickup-msg"),a=saveData.upgrades;if("ice"===e){let e=3;a.ice>=1&&(e+=1),a.ice>=2&&(e+=2),a.ice>=3&&(e+=0,kanye.halfSpeed=!0,kanye.halfSpeedTimer=3),kanye.frozen=!0,kanye.frozenTimer=e,document.getElementById("freeze-overlay").style.opacity="1",t.textContent=`‚ùÑÔ∏è KANYE FROZEN FOR ${e} SECONDS!`,document.getElementById("slot-ice").classList.add("active"),setTimeout((()=>document.getElementById("slot-ice").classList.remove("active")),1e3*e)}else if("speed"===e){let e=10;a.speed>=1&&(e+=3),a.speed>=2&&(e+=2),a.speed>=3&&(player.speedBoost=!0,player.speedBoostTimer=5),player.infiniteStamina=!0,player.infiniteStaminaTimer=e,document.getElementById("stamina-bar").classList.add("infinite"),a.speed>=3&&document.getElementById("stamina-bar").classList.add("boosted"),t.textContent=`‚ö° INFINITE STAMINA FOR ${e} SECONDS!`,document.getElementById("slot-speed").classList.add("active"),setTimeout((()=>document.getElementById("slot-speed").classList.remove("active")),1e3*e)}else"shield"===e&&(player.shieldHits>0?t.textContent="üõ°Ô∏è SHIELD ALREADY ACTIVE!":(player.shieldHits=a.shield>=3?2:1,document.getElementById("shield-indicator").style.opacity="1",t.textContent=a.shield>=3?"üõ°Ô∏è DOUBLE SHIELD ACQUIRED!":"üõ°Ô∏è SHIELD ACQUIRED!",document.getElementById("slot-shield").classList.add("active")));t.style.opacity="1",setTimeout((()=>{t.style.opacity="0"}),2e3)}function checkCoinCollection(){let e=!1;for(const t of coins){if(t.collected)continue;if(Math.hypot(t.x-player.x,t.z-player.z)<1.5){t.collected=!0,t.sprite&&scene.remove(t.sprite),sessionCoins++,document.getElementById("hud-coins").textContent="üí∞ "+sessionCoins,e=!0;const a=document.getElementById("pickup-msg");a.textContent="üí∞ +1 COIN",a.style.opacity="1",setTimeout((()=>{a.style.opacity="0"}),1e3)}}e&&setTimeout(spawnCoins,2e3)}function updateKanye(e){if(!kanye.sprite||isPaused)return;if(kanye.frozen)return kanye.frozenTimer-=e,kanye.frozenTimer<=0&&(kanye.frozen=!1,document.getElementById("freeze-overlay").style.opacity="0"),void kanye.sprite.material.color.setHex(kanye.frozen?8965375:16777215);kanye.halfSpeed&&(kanye.halfSpeedTimer-=e,kanye.halfSpeedTimer<=0&&(kanye.halfSpeed=!1));const t=kanye.halfSpeed?2.5:5.1;if(kanye.pathTimer-=e,kanye.pathTimer<=0){kanye.pathTimer=.35;const e=worldToGrid(kanye.x,kanye.z),t=worldToGrid(player.x,player.z),a=worldToGrid(player.x+(keys.KeyW||keys.KeyS||keys.KeyA||keys.KeyD?3*-Math.sin(player.yaw):0),player.z+(keys.KeyW||keys.KeyS||keys.KeyA||keys.KeyD?3*-Math.cos(player.yaw):0));let n=findPath(e.x,e.z,a.x,a.z);0===n.length&&(n=findPath(e.x,e.z,t.x,t.z)),kanye.path=n,kanye.pathIndex=0}let a=player.x,n=player.z;if(kanye.path.length>0)for(;kanye.pathIndex<kanye.path.length;){const e=kanye.path[kanye.pathIndex],t=gridToWorld(e.x,e.z);if(!(Math.hypot(t.x-kanye.x,t.z-kanye.z)<1.5&&kanye.pathIndex<kanye.path.length-1)){a=t.x,n=t.z;break}kanye.pathIndex++}const i=a-kanye.x,s=n-kanye.z,o=Math.hypot(i,s);if(o>.1){const a=i/o*t,n=s/o*t;kanye.vx+=3.5*(a-kanye.vx)*e,kanye.vz+=3.5*(n-kanye.vz)*e;const l=Math.hypot(kanye.vx,kanye.vz);l>t&&(kanye.vx=kanye.vx/l*t,kanye.vz=kanye.vz/l*t)}let l=kanye.x+kanye.vx*e,r=kanye.z+kanye.vz*e;isWalkableWorld(l,kanye.z,.4)||(l=kanye.x,kanye.vx*=-.3),isWalkableWorld(kanye.x,r,.4)||(r=kanye.z,kanye.vz*=-.3),kanye.x=l,kanye.z=r,kanye.sprite.position.set(kanye.x,1.25,kanye.z);const d=Math.hypot(kanye.x-player.x,kanye.z-player.z);setAudioVolume(d<70?Math.pow(1-d/70,.5):0);const c=document.getElementById("fear-overlay"),y=document.getElementById("warning");if(d<20?(c.style.opacity=.6*(1-d/20),y.style.opacity=d<10?1:0):(c.style.opacity=0,y.style.opacity=0),d<1.2)if(player.shieldHits>0){player.shieldHits--;let e=0;saveData.upgrades.shield>=1&&(e=1),saveData.upgrades.shield>=2&&(e=2),saveData.upgrades.shield>=3&&(e=2),e>0&&(kanye.frozen=!0,kanye.frozenTimer=e),player.shieldHits<=0&&(document.getElementById("shield-indicator").style.opacity="0",document.getElementById("slot-shield").classList.remove("active"));const t=Math.atan2(kanye.z-player.z,kanye.x-player.x);if(kanye.x+=8*Math.cos(t),kanye.z+=8*Math.sin(t),kanye.vx=10*Math.cos(t),kanye.vz=10*Math.sin(t),!isWalkableWorld(kanye.x,kanye.z,.4)){const e=worldToGrid(kanye.x,kanye.z);for(let t=1;t<10;t++){let a=!1;for(let n=-t;n<=t&&!a;n++)for(let i=-t;i<=t&&!a;i++)if(isWalkableGrid(e.x+n,e.z+i)){const t=gridToWorld(e.x+n,e.z+i);kanye.x=t.x,kanye.z=t.z,a=!0}if(a)break}}kanye.pathTimer=0;const a=document.getElementById("pickup-msg");a.textContent=player.shieldHits>0?"üõ°Ô∏è SHIELD BLOCKED! 1 HIT LEFT!":"üõ°Ô∏è SHIELD BLOCKED KANYE!",a.style.opacity="1",setTimeout((()=>{a.style.opacity="0"}),2e3)}else killPlayer()}function updateMinimap(){const e=document.getElementById("minimap-canvas"),t=e.getContext("2d"),a=e.width,n=e.height,i=a/GRID_SIZE;t.fillStyle="#0a0a0a",t.fillRect(0,0,a,n),t.fillStyle="#444";for(let e=0;e<GRID_SIZE;e++)for(let a=0;a<GRID_SIZE;a++)maze[e]&&1===maze[e][a]&&t.fillRect(e*i,a*i,i,i);for(const e of powerups){if(e.collected)continue;const a=(e.x/CELL+GRID_SIZE/2)*i,n=(e.z/CELL+GRID_SIZE/2)*i;t.fillStyle="ice"===e.type?"#88ccff":"speed"===e.type?"#ffcc00":"#44ff44",t.beginPath(),t.arc(a,n,3,0,2*Math.PI),t.fill()}for(const e of coins){if(e.collected)continue;const a=(e.x/CELL+GRID_SIZE/2)*i,n=(e.z/CELL+GRID_SIZE/2)*i;t.fillStyle="#ffd700",t.beginPath(),t.arc(a,n,2,0,2*Math.PI),t.fill()}const s=(player.x/CELL+GRID_SIZE/2)*i,o=(player.z/CELL+GRID_SIZE/2)*i;t.fillStyle="#4f4",t.beginPath(),t.arc(s,o,5,0,2*Math.PI),t.fill(),t.strokeStyle="#4f4",t.lineWidth=2,t.beginPath(),t.moveTo(s,o);const l=s-14*Math.sin(player.yaw),r=o-14*Math.cos(player.yaw);t.lineTo(l,r),t.stroke();const d=(kanye.x/CELL+GRID_SIZE/2)*i,c=(kanye.z/CELL+GRID_SIZE/2)*i;t.fillStyle=kanye.frozen?"#88ccff":"#f44",t.beginPath(),t.arc(d,c,5,0,2*Math.PI),t.fill()}function updateTimer(){const e=(Date.now()-startTime)/1e3,t=Math.floor(e/60),a=Math.floor(e%60);document.getElementById("timer").textContent=`${t}:${a.toString().padStart(2,"0")}`}function killPlayer(){if(isDead)return;isDead=!0;const e=(Date.now()-startTime)/1e3,t=Math.floor(e/60),a=Math.floor(e%60);saveData.highscores.push(e),saveData.highscores.sort(((e,t)=>t-e)),saveData.highscores=saveData.highscores.slice(0,3),saveData.coins+=sessionCoins,saveSaveData(),document.getElementById("survival-time").textContent=`Survived: ${t}:${a.toString().padStart(2,"0")}`,document.getElementById("coins-earned").textContent=`+${sessionCoins} coins`,document.getElementById("death-screen").style.display="flex",stopAudio(),document.exitPointerLock()}function togglePause(){gameStarted&&!isDead&&(isPaused=!isPaused,document.getElementById("pause-screen").style.display=isPaused?"flex":"none",isPaused?document.exitPointerLock():renderer.domElement.requestPointerLock())}function resumeGame(){isPaused=!1,document.getElementById("pause-screen").style.display="none",renderer.domElement.requestPointerLock()}function quitGame(){sessionCoins=0,returnToMenu()}function returnToMenu(){gameStarted=!1,isPaused=!1,isDead=!1,stopAudio(),document.exitPointerLock(),document.getElementById("death-screen").style.display="none",document.getElementById("pause-screen").style.display="none",document.getElementById("start-screen").classList.remove("hidden"),updateUI()}function init(){loadSaveData(),scene=new THREE.Scene,scene.background=new THREE.Color(1710618),scene.fog=new THREE.Fog(1710618,2,30),camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,100),renderer=new THREE.WebGLRenderer({antialias:!1,powerPreference:"low-power"}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setPixelRatio(1),document.body.appendChild(renderer.domElement);const e=document.getElementById("minimap-canvas");e.width=160,e.height=160,loadTextures((()=>{generateMaze(),buildWorld(),createKanye()})),document.addEventListener("keydown",(e=>{keys[e.code]=!0,e.code===sprintKeyCode&&(isSprinting=!0),"Space"===e.code&&e.preventDefault(),"Escape"===e.code&&gameStarted&&!isDead&&(e.preventDefault(),togglePause())})),document.addEventListener("keyup",(e=>{keys[e.code]=!1,e.code===sprintKeyCode&&(isSprinting=!1)})),document.addEventListener("mousemove",(e=>{isLocked&&gameStarted&&!isDead&&!isPaused&&(player.yaw-=e.movementX*mouseSensitivity,player.pitch-=e.movementY*mouseSensitivity,player.pitch=Math.max(-1.4,Math.min(1.4,player.pitch)))})),document.addEventListener("pointerlockchange",(()=>{isLocked=document.pointerLockElement===renderer.domElement})),renderer.domElement.addEventListener("click",(()=>{!gameStarted||isDead||isPaused||renderer.domElement.requestPointerLock()})),window.addEventListener("resize",(()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}))}let lastTime=0;function animate(e){requestAnimationFrame(animate);const t=Math.min((e-lastTime)/1e3,.05);lastTime=e,!gameStarted||isDead||isPaused||(updatePlayer(t),updateKanye(t),updateMinimap(),updateTimer()),renderer.render(scene,camera)}function startGame(){document.getElementById("start-screen").classList.add("hidden"),gameStarted=!0,startTime=Date.now(),stamina=100,sessionCoins=0,document.getElementById("hud-coins").textContent="üí∞ 0",spawnEntities(),initAudio(),renderer.domElement.requestPointerLock()}function restartGame(){for(;scene.children.length>0;)scene.remove(scene.children[0]);generateMaze(),buildWorld(),createKanye(),spawnEntities(),isDead=!1,stamina=100,startTime=Date.now(),sessionCoins=0,document.getElementById("hud-coins").textContent="üí∞ 0",kanye.pathTimer=0,kanye.frozen=!1,kanye.halfSpeed=!1,kanye.vx=0,kanye.vz=0,document.getElementById("death-screen").style.display="none",document.getElementById("fear-overlay").style.opacity=0,document.getElementById("warning").style.opacity=0,document.getElementById("freeze-overlay").style.opacity=0,document.getElementById("shield-indicator").style.opacity=0,document.getElementById("stamina-bar").classList.remove("infinite"),document.getElementById("stamina-bar").classList.remove("boosted"),document.querySelectorAll(".powerup-slot").forEach((e=>e.classList.remove("active"))),renderer.domElement.requestPointerLock()}init(),requestAnimationFrame(animate);</script>
</body>
</html>
